<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoCheck-In Pro (Roster)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .view { display: none; } 
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        .admin-float-btn {
            position: fixed; top: 1rem; right: 1rem; z-index: 50;
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 9999px;
            padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #475569;
            display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;
            cursor: pointer; border: 1px solid #e2e8f0;
        }
        .admin-float-btn:hover { background-color: #f1f5f9; transform: translateY(-1px); }
        .history-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .history-card.active .history-content { max-height: 500px; overflow-y: auto; }
        .history-card.active .chevron-icon { transform: rotate(180deg); }
        input[type="time"]::-webkit-calendar-picker-indicator { cursor: pointer; }
        
        /* Rules Card Style */
        .rules-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .cleared-record { opacity: 0.6; background-color: #f0fdf4 !important; }
        .cleared-record .record-name { text-decoration: line-through; color: #15803d; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <!-- ‡∏õ‡∏∏‡πà‡∏° Admin -->
    <button id="global-admin-btn" onclick="router.navigate('admin_login')" class="admin-float-btn">
        <i data-lucide="shield-check" class="w-4 h-4"></i> Admin
    </button>

    <!-- 1. LOADING VIEW -->
    <div id="view-loading" class="view min-h-screen flex items-center justify-center bg-white">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-slate-500 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
        </div>
    </div>

    <!-- 2. ADMIN LOGIN -->
    <div id="view-admin_login" class="view min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center relative">
            <h2 class="text-xl font-bold text-slate-800 mb-6">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="password" id="admin-pin-input" maxlength="4" class="w-full text-center text-3xl tracking-[1em] p-3 border-b-2 border-slate-200 mb-6 focus:outline-none focus:border-indigo-600" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus />
            <div class="flex gap-3">
                <button onclick="router.navigate('user_dashboard')" class="flex-1 bg-slate-100 p-3 rounded-xl text-slate-600">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onclick="app.checkAdminLogin()" class="flex-1 bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- 3. ADMIN DASHBOARD -->
    <div id="view-admin_dashboard" class="view min-h-screen bg-slate-50 pb-20">
        <header class="bg-indigo-900 text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
            <h1 class="font-bold flex items-center gap-2 text-lg"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Admin Dashboard</h1>
            <button onclick="window.location.reload()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" class="opacity-80 hover:opacity-100"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
        </header>

        <main class="max-w-3xl mx-auto p-4 space-y-6">
            <!-- Auto Archive Status -->
            <div id="auto-archive-status" class="hidden bg-blue-50 text-blue-700 px-4 py-3 rounded-xl text-sm border border-blue-100 flex items-center gap-2 animate-pulse">
                <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà...
            </div>

            <!-- SYSTEM STATUS CONTROL -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                        <i data-lucide="power" class="w-4 h-4 text-slate-500"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    </h3>
                    <span id="admin-system-status-badge" class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-600">Loading...</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="app.handleSetSystemOverride(null)" id="btn-mode-auto" class="py-2 px-1 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-50 transition flex flex-col items-center gap-1">
                        <i data-lucide="calendar-clock" class="w-4 h-4 text-slate-500"></i> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏à-‡∏®)
                    </button>
                    <button onclick="app.handleSetSystemOverride('open')" id="btn-mode-open" class="py-2 px-1 rounded-lg text-xs font-medium border border-green-200 bg-green-50 text-green-700 hover:bg-green-100 transition flex flex-col items-center gap-1">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î
                    </button>
                    <button onclick="app.handleSetSystemOverride('closed')" id="btn-mode-closed" class="py-2 px-1 rounded-lg text-xs font-medium border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 transition flex flex-col items-center gap-1">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î
                    </button>
                </div>
            </div>

            <!-- TODAY CARD -->
            <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 p-5 text-white flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold">TODAY</span>
                            <span class="text-sm opacity-90" id="today-date-display">...</span>
                        </div>
                        <h2 class="text-2xl font-bold" id="today-day-name">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold"><span id="today-checked-in">0</span>/<span id="today-total">0</span></div>
                        <div class="text-xs opacity-80">‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                </div>
                
                <!-- Action Bar & Settings -->
                <div class="bg-indigo-50 p-4 border-b border-indigo-100 space-y-3">
                    <!-- Row 1: Location & Roster -->
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-indigo-600 flex flex-col gap-0.5">
                            <div class="flex items-center gap-1 font-bold">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠:
                            </div>
                            <span id="admin-location-status" class="font-mono text-[10px] bg-white px-1.5 py-0.5 rounded border border-indigo-100">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('modal-rules').classList.remove('hidden')" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-50 flex items-center gap-1">
                                <i data-lucide="scroll-text" class="w-3 h-3"></i> ‡∏Å‡∏è‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤
                            </button>
                            <button onclick="document.getElementById('modal-add-roster').classList.remove('hidden')" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-50 flex items-center gap-1">
                                <i data-lucide="users" class="w-3 h-3"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                            </button>
                            <button onclick="app.handleSetTargetLocation()" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-50">‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
                        </div>
                    </div>
                    
                    <!-- Row 2: Late Time -->
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-indigo-200 shadow-sm">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <i data-lucide="clock" class="w-4 h-4 text-orange-500"></i>
                            <span class="font-bold">‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="time" id="admin-late-time-input" class="border border-slate-300 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:border-indigo-500">
                            <button onclick="app.handleSetLateTime()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>

                    <!-- Row 3: Radius -->
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-indigo-200 shadow-sm">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <i data-lucide="ruler" class="w-4 h-4 text-blue-500"></i>
                            <span class="font-bold">‡∏£‡∏±‡∏®‡∏°‡∏µ (‡πÄ‡∏°‡∏ï‡∏£):</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="admin-radius-input" class="border border-slate-300 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:border-indigo-500 w-20 text-center" placeholder="100">
                            <button onclick="app.handleSetRadius()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>

                    <!-- Row 4 (New): Dynamic Time Rules -->
                    <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 shadow-sm space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-yellow-800 font-bold">
                                <i data-lucide="settings-2" class="w-4 h-4"></i>
                                ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:
                            </div>
                            <div class="flex items-center">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="admin-dynamic-time-toggle" class="sr-only peer" onchange="app.handleToggleDynamicTime(this.checked)">
                                    <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-slate-600">‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ô‡∏≤‡∏ó‡∏µ):</span>
                            <div class="flex gap-1">
                                <input type="number" id="admin-max-penalty-input" class="w-12 border border-slate-300 rounded px-1 text-center focus:outline-none focus:border-yellow-500" placeholder="5" value="5">
                                <button onclick="app.handleSetMaxPenalty()" class="bg-yellow-600 text-white px-2 py-0.5 rounded hover:bg-yellow-700">Set</button>
                            </div>
                        </div>
                    </div>

                    <!-- Row 5: Test Mode -->
                    <div class="flex items-center justify-between bg-purple-50 p-2 rounded-lg border border-purple-200 shadow-sm">
                        <div class="flex items-center gap-2 text-sm text-purple-700">
                            <i data-lucide="flask-conical" class="w-4 h-4"></i>
                            <span class="font-bold">‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (PC):</span>
                        </div>
                        <div class="flex items-center">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="admin-testmode-toggle" class="sr-only peer" onchange="app.handleToggleTestMode(this.checked)">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Row 6: Full Reset (New) -->
                    <div class="flex items-center justify-between bg-red-50 p-2 rounded-lg border border-red-200 shadow-sm mt-2">
                        <div class="flex items-center gap-2 text-sm text-red-700">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                            <span class="font-bold">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà):</span>
                        </div>
                        <button onclick="app.handleFullReset()" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700 shadow-sm">
                            <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                        </button>
                    </div>
                </div>

                <div class="p-0">
                    <div id="today-users-list" class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto"></div>
                </div>
            </div>

            <!-- HISTORY -->
            <div>
                <div class="flex justify-between items-center mb-3 ml-1 mt-6">
                    <h3 class="font-bold text-slate-600 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    </h3>
                    <button onclick="app.handleClearAllHistory()" class="text-[10px] text-red-400 hover:text-red-600 hover:underline flex items-center gap-1">
                        <i data-lucide="trash" class="w-3 h-3"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
                <div id="history-container" class="space-y-3">
                    <p class="text-center text-slate-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>
            </div>

            <!-- PENDING -->
            <div id="admin-pending-wrapper" class="hidden mt-8">
                <h3 class="font-bold text-amber-600 mb-3 ml-1 flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (<span id="pending-count">0</span>)</h3>
                <div id="admin-pending-list" class="bg-amber-50 rounded-xl border border-amber-100 p-2 space-y-2"></div>
            </div>
        </main>
    </div>

    <!-- MODAL RULES -->
    <div id="modal-rules" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    
    <div id="rules-capture-target" class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden relative">
        
        <div id="rules-action-btns" class="absolute top-2 right-2 z-10 flex gap-2">
            <button onclick="app.handleExportRules()" class="text-white/80 hover:text-white bg-black/20 hover:bg-emerald-500 rounded-full p-1 transition-colors" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
            <button onclick="document.getElementById('modal-rules').classList.add('hidden')" class="text-white/80 hover:text-white bg-black/20 hover:bg-red-500 rounded-full p-1 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="rules-gradient p-6 text-white text-center pb-8">
            <i data-lucide="scale" class="w-12 h-12 mx-auto mb-3 text-white/90"></i>
            <h2 class="text-2xl font-bold mb-1">‡∏Å‡∏è‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏°.3</h2>
            <div class="mt-2 inline-block bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg border border-white/30">
                <p class="text-white/90 text-xs">‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</p>
                <p class="text-xl font-bold" id="rules-base-time">--:--</p>
            </div>
        </div>
        
        <div class="p-6 -mt-4 bg-white rounded-t-3xl relative z-0 h-[60vh] overflow-y-auto">
            <div class="space-y-4 text-sm">
                
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <h3 class="font-bold text-indigo-700 mb-2 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
                    </h3>
                    <ul class="space-y-2 text-xs text-slate-600">
                        <li class="flex items-start gap-2">
                            <span class="text-red-500 font-bold">‚Ä¢</span>
                            <span><strong class="text-slate-800">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏î‡∏•‡∏á <strong class="text-red-600">5 ‡∏ô‡∏≤‡∏ó‡∏µ</strong></span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-orange-500 font-bold">‚Ä¢</span>
                            <span><strong class="text-slate-800">‡∏°‡∏≤‡∏™‡∏≤‡∏¢:</strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏î‡∏•‡∏á <strong class="text-orange-600">3 ‡∏ô‡∏≤‡∏ó‡∏µ</strong></span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-500 font-bold">‚Ä¢</span>
                            <span><strong class="text-slate-800">‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</strong> ‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô <strong class="text-green-600">2 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ß‡∏±‡∏ô</strong> (‡∏à‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥)</span>
                        </li>
                    </ul>
                    <div class="mt-2 pt-2 border-t border-indigo-200 text-[10px] text-indigo-600">
                        * ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô <strong id="rules-max-penalty">--</strong> ‡∏ô‡∏≤‡∏ó‡∏µ
                        <br>
                        * ‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô 07:50 ‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏ô‡∏µ‡πâ
                    </div>
                </div>

                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <h3 class="font-bold text-emerald-700 mb-1 flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-4 h-4"></i> ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô
                    </h3>
                    <p class="text-xs text-emerald-800 ml-6">
                        ‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≤‡∏†‡∏±‡∏Ñ‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå
                    </p>
                </div>

                <div class="space-y-2">
                    <p class="font-bold text-slate-800 border-b pb-1">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏î‡πÄ‡∏ä‡∏¢</p>
                    
                    <div class="flex items-start gap-3">
                        <div class="bg-yellow-100 text-yellow-700 p-1.5 rounded"><i data-lucide="alert-circle" class="w-4 h-4"></i></div>
                        <div>
                            <p class="font-bold text-slate-700 text-xs">‡∏™‡∏≤‡∏¢ 1 - 10 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                            <p class="text-slate-500 text-[10px]">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="bg-orange-100 text-orange-700 p-1.5 rounded"><i data-lucide="alert-triangle" class="w-4 h-4"></i></div>
                        <div>
                            <p class="font-bold text-slate-700 text-xs">‡∏™‡∏≤‡∏¢ 11 - 40 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                            <p class="text-slate-500 text-[10px]">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 2 ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ô‡∏≤‡∏ó‡∏µ</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="bg-red-100 text-red-700 p-1.5 rounded"><i data-lucide="x-circle" class="w-4 h-4"></i></div>
                        <div>
                            <p class="font-bold text-slate-700 text-xs">‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</p>
                            <p class="text-slate-500 text-[10px]">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3 pt-2 border-t border-slate-100 mt-1">
                        <div class="bg-blue-100 text-blue-700 p-1.5 rounded"><i data-lucide="heart-pulse" class="w-4 h-4"></i></div>
                        <div>
                            <p class="font-bold text-slate-700 text-xs">‡∏•‡∏≤‡∏Å‡∏¥‡∏à / ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</p>
                            <p class="text-slate-500 text-[10px]">‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL ADD ROSTER -->
    <div id="modal-add-roster" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <p class="text-sm text-slate-500 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏ä‡∏∑‡πà‡∏≠)</p>
            <textarea id="roster-textarea" rows="5" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-500" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ&#10;‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô&#10;‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô"></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('modal-add-roster').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="app.handleAddRoster()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-sm hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT STATUS -->
    <div id="modal-status-edit" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
            <p id="modal-status-name" class="text-sm text-slate-500 mb-4">...</p>
            <div class="space-y-2">
                <button onclick="app.handleSaveStatus('sick_leave')" class="w-full bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-bold hover:bg-blue-200">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</button>
                <button onclick="app.handleSaveStatus('personal_leave')" class="w-full bg-purple-100 text-purple-700 py-2 rounded-lg text-sm font-bold hover:bg-purple-200">üíº ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</button>
                <button onclick="app.handleSaveStatus('other')" class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg text-sm font-bold hover:bg-slate-300">‚ûñ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (-)</button>
                <button onclick="app.handleSaveStatus(null)" class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg text-sm font-bold hover:bg-slate-200">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏Å‡∏ï‡∏¥)</button>
            </div>
            <button onclick="document.getElementById('modal-status-edit').classList.add('hidden')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>
	
	<div id="modal-redeem-trash" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-2">üóëÔ∏è ‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
            <p id="redeem-user-name" class="text-slate-600 mb-4 font-bold">...</p>
            
            <div class="bg-slate-100 p-3 rounded-lg mb-4 text-center">
                <p class="text-xs text-slate-500">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                <p id="redeem-current-debt" class="text-3xl font-bold text-orange-600">0</p>
                <p class="text-xs text-slate-400">‡∏ä‡∏¥‡πâ‡∏ô</p>
            </div>

            <label class="text-xs text-slate-700 font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏°‡∏≤‡∏™‡πà‡∏á (‡∏ä‡∏¥‡πâ‡∏ô):</label>
            <input type="number" id="redeem-amount-input" class="w-full border border-slate-300 rounded-lg p-2 text-lg text-center font-bold focus:outline-none focus:border-indigo-500 mt-1 mb-4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30">
            
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-redeem-trash').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="app.handleRedeemSubmit()" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-green-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- 4. USER APPROVED VIEW -->
    <div id="view-user_approved" class="view min-h-screen bg-slate-50 flex flex-col">
        <div id="user-header-bg" class="bg-indigo-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500">
            <div class="mt-4 mb-2 inline-block p-4 bg-white/20 rounded-full backdrop-blur-sm">
                <i id="user-status-icon" data-lucide="wifi" class="w-12 h-12"></i>
            </div>
            <h2 id="user-status-title" class="text-2xl font-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h2>
            <p id="user-status-message" class="text-white/80 text-sm mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS...</p>
            
            <!-- New: User Specific Time Display -->
            <div id="user-target-time-wrapper" class="hidden mt-4 bg-white/10 rounded-lg p-2 backdrop-blur-sm">
                <div class="text-[10px] text-white/80 uppercase tracking-widest" id="user-target-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                <div class="text-2xl font-bold font-mono" id="user-target-time-display">--:--</div>
                <div class="text-xs text-yellow-300 font-bold mt-1" id="user-countdown-display"></div>
            </div>
        </div>
        <main class="flex-1 p-6 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between border-b border-slate-50 pb-3 mb-3">
                    <span class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    <span id="user-name-display" class="font-bold text-slate-800">...</span>
                </div>
                <!-- ‡∏õ‡∏£‡∏±‡∏ö Grid ‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-slate-50 p-3 rounded-lg text-center">
                        <div class="text-[10px] text-slate-400 mb-1">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</div>
                        <div id="user-rank-display" class="font-bold text-slate-800 text-lg">-</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg text-center">
                        <div class="text-[10px] text-slate-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</div>
                        <div id="user-time-display" class="font-bold text-slate-800 text-lg">-</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg text-center">
                        <div class="text-[10px] text-slate-400 mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á</div>
                        <div id="user-distance-display" class="font-bold text-slate-800 text-lg">-</div>
                    </div>
                </div>
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                <div class="mt-3 pt-2 border-t border-slate-50 flex justify-between items-center text-[10px]">
    <span class="text-slate-400">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</span>
    <div class="flex items-center gap-2">
        <span class="font-mono text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded" id="user-current-coords">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤...</span>
        <button onclick="app.stopGPS(); setTimeout(() => app.startGPS(), 500);" class="bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
        </button>
    </div>
</div>
            </div>

            <div id="user-penalty-card" class="hidden bg-orange-50 border border-orange-200 p-5 rounded-2xl shadow-sm text-center animate-pulse">
                <h3 class="text-orange-800 font-bold flex items-center justify-center gap-2 mb-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢
                </h3>
                <p id="user-penalty-detail" class="text-orange-700 text-lg font-bold">...</p>
                <p id="user-penalty-sub" class="text-orange-600 text-xs mt-1">...</p>
            </div>

            <!-- WHO IS HERE -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2 text-sm">
                    <i data-lucide="users" class="w-4 h-4"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </h3>
                <div id="user-peer-list" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    <p class="text-xs text-slate-400 text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</p>
                </div>
            </div>

            <div id="user-no-target-warning" class="hidden text-center text-red-500 text-sm bg-red-50 p-3 rounded-lg">‚ö†Ô∏è Admin ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</div>
            <div class="text-center mt-8"><p class="text-[10px] text-slate-300" id="approved-device-uid">Device UID: ...</p></div>
        </main>
    </div>

    <!-- 5. USER PENDING VIEW -->
    <div id="view-user_pending" class="view min-h-screen bg-slate-100 flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center pt-12">
            <div class="bg-amber-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="clock" class="text-amber-500 w-10 h-10 animate-pulse"></i></div>
            <h2 class="text-xl font-bold text-slate-800">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
            <p class="text-slate-500 mt-2 mb-6">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
            <div class="bg-slate-50 p-3 rounded-lg mb-6 text-sm text-left">
                <div class="flex justify-between mb-1"><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠:</span> <span id="pending-name-display">...</span></div>
                <div class="flex justify-between"><span class="text-slate-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> <span class="text-amber-500 font-bold">Pending</span></div>
            </div>
            <div class="mt-8 pt-4 border-t border-slate-100 flex flex-col items-center">
                <button onclick="app.handleResetIdentity()" class="flex items-center gap-1 text-[10px] text-red-400 hover:text-red-600 hover:underline"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)</button>
            </div>
        </div>
    </div>

    <!-- 6. USER REGISTER VIEW -->
    <div id="view-user_register" class="view min-h-screen bg-white flex flex-col">
        <header class="bg-slate-900 text-white p-6 pt-16 rounded-b-3xl shadow-lg relative">
            <div class="mt-4 text-center">
                <i data-lucide="user-plus" class="w-12 h-12 mx-auto mb-4 opacity-90"></i>
                <h1 class="text-2xl font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h1>
                <p class="text-slate-400 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
        </header>
        <main class="flex-1 p-8 flex flex-col justify-center">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <select id="register-name-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-600 focus:outline-none transition appearance-none">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
                    </select>
                </div>
                <button onclick="app.handleRequestAccess()" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                <div class="text-center pt-4">
                    <p class="text-xs text-slate-400">‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠? ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin</p>
                </div>
            </div>
        </main>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, serverTimestamp, deleteDoc, query, orderBy, limit, addDoc, deleteField, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHmJ7M5qf20lKPTB9_aE2Ppa0-jTryuuI",
            authDomain: "programpp-91f08.firebaseapp.com",
            projectId: "programpp-91f08",
            storageBucket: "programpp-91f08.firebasestorage.app",
            messagingSenderId: "415403943738",
            appId: "1:415403943738:web:f56ec72de49f81f0315203",
            measurementId: "G-W19QNQQR25"
        };
        const appId = 'default-app-id';
        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);
        const ADMIN_PIN = "2741";

        const state = {
            currentUser: null,
            targetLocation: null,
            lateTime: "07:00",
            checkInRadius: 100,
            testMode: false,
            systemStatusOverride: null, // null=Auto, 'open', 'closed'
            enableDynamicTime: false, // New
            maxPenaltyMinutes: 5, // New
            usersList: [],
            rosterList: [], // List of all names
            pendingRequests: [],
            historyList: [],
            myUserData: null,
            myPendingRequest: null,
            gpsWatchId: null,
            systemDate: null,
            editingRosterId: null, // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
            countDownInterval: null,
			redeemTarget: null,
			isProcessingCheckIn: false,
        };

        const router = {
            navigate: (viewName) => {
                if (viewName === 'user_dashboard') { app.routeUserDashboard(); return; }
                document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
                const target = document.getElementById(`view-${viewName}`);
                if(target) {
                    target.style.display = target.classList.contains('flex') ? 'flex' : 'block';
                    lucide.createIcons();
                }
                const adminBtn = document.getElementById('global-admin-btn');
                if (viewName.startsWith('admin_') || viewName === 'loading') {
                    adminBtn.style.display = 'none';
                } else {
                    adminBtn.style.display = 'flex';
                }
            }
        };

        const app = {
            // --- 1. INITIALIZATION & UTILS ---
            init: () => {
                router.navigate('loading');
                app.updateTodayDateDisplay();
                onAuthStateChanged(auth, (user) => {
                    state.currentUser = user;
                    if (user) {
                        app.syncData();
                        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Login
                        router.navigate('admin_dashboard');
                        app.checkAndRunAutoArchive(); // ‡∏£‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î/‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                    } else {
                        app.signIn();
                    }
                });
            },
			
			handleExportRules: async () => {
                const target = document.getElementById('rules-capture-target');
                const btnGroup = document.getElementById('rules-action-btns');
                btnGroup.style.display = 'none';
                try {
                    const canvas = await html2canvas(target, { scale: 3, useCORS: true, backgroundColor: null });
                    const link = document.createElement('a');
                    link.download = `Rules_M3_${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (err) { console.error(err); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } 
                finally { btnGroup.style.display = 'flex'; }
            },

            signIn: async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } },

            updateTodayDateDisplay: () => {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('today-date-display').textContent = now.toLocaleDateString('th-TH', options);
                document.getElementById('today-day-name').textContent = now.toLocaleDateString('th-TH', { weekday: 'long' });
            },

            getTodayStr: () => { return new Date().toLocaleDateString('en-CA'); },

            getSystemStatus: () => {
                if (state.systemStatusOverride === 'open') return { active: true, label: '‡πÄ‡∏õ‡∏¥‡∏î (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', color: 'text-green-600' };
                if (state.systemStatusOverride === 'closed') return { active: false, label: '‡∏õ‡∏¥‡∏î (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', color: 'text-red-600' };
                const day = new Date().getDay();
                const isWeekend = day === 0 || day === 6;
                if (isWeekend) return { active: false, label: '‡∏õ‡∏¥‡∏î (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)', color: 'text-slate-500' };
                return { active: true, label: '‡πÄ‡∏õ‡∏¥‡∏î (‡∏õ‡∏Å‡∏ï‡∏¥)', color: 'text-green-600' };
            },

            // --- 2. LOGIC & CALCULATION ---
            predictNextTime: (user) => {
    if (!state.enableDynamicTime) return { time: state.lateTime, label: '‡∏õ‡∏Å‡∏ï‡∏¥', penalty: 0 };

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô ---
    const sysStatus = app.getSystemStatus();
    let currentPenalty = user.penaltyMinutes || 0;
    
    // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ó‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°
    if (!sysStatus.active) {
        const [h, m] = state.lateTime.split(':').map(Number);
        const d = new Date();
        d.setHours(h, m - currentPenalty, 0, 0); // ‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏©‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return { time: timeStr, label: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', penalty: currentPenalty };
    }
    // ------------------------------------
    
    let nextPenalty = currentPenalty;
    let label = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                const [h, m] = state.lateTime.split(':').map(Number);
                const targetDateToday = new Date();
                targetDateToday.setHours(h, m - currentPenalty, 0, 0);
                
                // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∑‡∏≠ 40 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
                const absentThreshold = new Date(targetDateToday.getTime() + 40 * 60000);
                const now = new Date();
                const todayStr = app.getTodayStr();

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (Manual Status) ‡∏à‡∏≤‡∏Å Roster
                const rosterItem = state.rosterList.find(r => r.assignedUid === user.id);
                const isLeave = rosterItem && rosterItem.manualStatus && rosterItem.manualStatusDate === todayStr;

                if (isLeave) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏•‡∏î‡∏•‡∏á
                    label = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                    // nextPenalty ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                } else if (app.isUserCheckedInToday(user)) {
                    label = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                    // FIXED: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏ó‡∏©‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (clearedToday)
                    if (user.clearedToday) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏ó‡∏© ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏¢)
                        if (user.status === 'on_time') nextPenalty -= 2;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏ó‡∏© ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                        let status = user.status;
                        if (status === 'on_time') {
                             nextPenalty -= 2;
                        } else if (status && status.includes('late')) {
                             nextPenalty += 3;
                        } else if (status === 'absent') {
                             nextPenalty += 5;
                        }
                    }
                } else {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≤
                    if (now > absentThreshold) {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (+5 ‡∏ô‡∏≤‡∏ó‡∏µ)
                        label = '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                        
                        // FIXED: ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏ó‡∏© (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Reset ‡∏´‡∏£‡∏∑‡∏≠ Clear) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å‡πÇ‡∏ó‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        if (!user.clearedToday) {
                             nextPenalty += 5; 
                        }
                    } else {
                        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏î -> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        label = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                    }
                }

                nextPenalty = Math.max(0, Math.min(state.maxPenaltyMinutes, nextPenalty));
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏≠‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ê‡∏≤‡∏ô - ‡πÇ‡∏ó‡∏©‡πÉ‡∏´‡∏°‡πà)
                const d = new Date();
                d.setHours(h, m - nextPenalty, 0, 0);
                const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                
                return { time: timeStr, label, penalty: nextPenalty };
            },

            calculateLateStatus: (checkInDateObj, lateTimeStr) => {
                const [lateHour, lateMinute] = lateTimeStr.split(':').map(Number);
                const lateThreshold = new Date(checkInDateObj);
                lateThreshold.setHours(lateHour, lateMinute, 0, 0);
                const diffMs = checkInDateObj - lateThreshold;
                const diffMins = Math.ceil(diffMs / 60000);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° return trashScore (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°)
                if (diffMins <= 0) return { status: 'on_time', penalty: '-', lateMinutes: 0, trashScore: 0 };
                else if (diffMins <= 10) return { status: 'late_mild', penalty: '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô', lateMinutes: diffMins, trashScore: 20 };
                else if (diffMins <= 40) { 
                    const pieces = diffMins * 2; 
                    return { status: 'late_heavy', penalty: `‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ ${pieces} ‡∏ä‡∏¥‡πâ‡∏ô`, lateMinutes: diffMins, trashScore: pieces }; 
                }
                else return { status: 'absent', penalty: '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô', lateMinutes: diffMins, trashScore: 20 };
            },

            calculateDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            },
            
            formatTime: (t) => { if (!t) return '-'; try { return (t.toDate ? t.toDate() : new Date(t)).toLocaleString('th-TH'); } catch (e) { return '-'; } },

            isUserCheckedInToday: (user) => { return user && user.checkInDate === app.getTodayStr(); },

            // --- 3. GPS FUNCTIONS (MOVED UP FOR SAFETY) ---
            startGPS: () => {
                const sysStatus = app.getSystemStatus();
                if (!sysStatus.active) return; 

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô PC
                if (state.testMode) {
                    document.getElementById('user-status-message').textContent = 'üß™ Test Mode Active: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠...';
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                const { latitude, longitude } = pos.coords;
                                document.getElementById('user-current-coords').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                                app.handleAutoCheckIn();
                            }, 
                            (err) => {
                                document.getElementById('user-current-coords').textContent = 'Test Mode (No GPS)';
                                app.handleAutoCheckIn();
                            }
                        );
                    } else {
                        app.handleAutoCheckIn();
                    }
                    return;
                }

                if (state.gpsWatchId) return;

                if ('geolocation' in navigator && state.targetLocation && state.myUserData) {
                    document.getElementById('user-status-message').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS...';
                    
                    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GPS ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ---
                    const gpsOptions = {
                        enableHighAccuracy: true, // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                        timeout: 20000,           // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ß‡∏¥ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ü‡πâ‡∏≠‡∏á error ‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á
                        maximumAge: 0             // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
                    };

                    state.gpsWatchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const { latitude, longitude, accuracy } = pos.coords; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (accuracy) ‡∏°‡∏≤‡∏î‡∏π‡∏î‡πâ‡∏ß‡∏¢
                            const dist = app.calculateDistance(latitude, longitude, state.targetLocation.lat, state.targetLocation.lng);
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
                            document.getElementById('user-distance-display').textContent = Math.round(dist) + ' ‡∏°.';
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î + ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡∏≠‡∏ô Debug)
                            document.getElementById('user-current-coords').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${Math.round(accuracy)}‡∏°.)`;

                            const radius = state.checkInRadius;
                            
                            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞
                            if (dist <= radius) {
                                document.getElementById('user-distance-display').className = 'font-bold text-green-600 text-lg';
                                document.getElementById('user-status-message').textContent = '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚úÖ';
                                app.handleAutoCheckIn();
                            } else {
                                document.getElementById('user-distance-display').className = 'font-bold text-red-500 text-lg';
                                document.getElementById('user-status-message').textContent = `‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (${Math.round(dist)} ‡∏°.)`;
                            }
                        },
                        (err) => {
                            // --- ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ Error ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ---
                            let msg = '‚ùå GPS ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                            switch(err.code) {
                                case 1: // PERMISSION_DENIED
                                    msg = 'üö´ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" (Allow) ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                                    alert('‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï/Allow"');
                                    break;
                                case 2: // POSITION_UNAVAILABLE
                                    msg = 'üì° ‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Wi-Fi)';
                                    break;
                                case 3: // TIMEOUT
                                    msg = '‚è±Ô∏è ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤/GPS ‡∏≠‡πà‡∏≠‡∏ô)';
                                    // ‡∏ñ‡πâ‡∏≤ Timeout ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö (Retry)
                                    app.stopGPS();
                                    setTimeout(() => app.startGPS(), 2000); 
                                    break;
                                default:
                                    msg = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
                            }
                            console.warn('GPS Error:', err);
                            document.getElementById('user-status-message').textContent = msg;
                        },
                        gpsOptions
                    );
                } else {
                    alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
                }
            },

            stopGPS: () => { if (state.gpsWatchId) { navigator.geolocation.clearWatch(state.gpsWatchId); state.gpsWatchId = null; } },

            // --- 4. UI RENDERING & NAVIGATION ---
            updateUserDashboardUI: () => {
                if (!state.myUserData) return;
                const u = state.myUserData;
                const isCheckedInToday = app.isUserCheckedInToday(u);
                
                document.getElementById('user-name-display').textContent = u.name;
                document.getElementById('user-time-display').textContent = isCheckedInToday ? app.formatTime(u.checkInTime).split(' ')[1] : '-';
                
                let rankStr = '-';
                if (isCheckedInToday) {
                    const todayUsers = state.usersList.filter(user => app.isUserCheckedInToday(user));
                    todayUsers.sort((a, b) => {
                        const timeA = a.checkInTime ? (a.checkInTime.toDate ? a.checkInTime.toDate() : new Date(a.checkInTime)) : 0;
                        const timeB = b.checkInTime ? (b.checkInTime.toDate ? b.checkInTime.toDate() : new Date(b.checkInTime)) : 0;
                        return timeA - timeB;
                    });
                    const myRank = todayUsers.findIndex(user => user.id === u.id) + 1;
                    rankStr = myRank > 0 ? `#${myRank}` : '-';
                }
                document.getElementById('user-rank-display').textContent = rankStr;

                const targetWrapper = document.getElementById('user-target-time-wrapper');
                const targetTimeDisplay = document.getElementById('user-target-time-display');
                const countdownDisplay = document.getElementById('user-countdown-display');
                const targetLabel = document.getElementById('user-target-label');

                if (state.countDownInterval) {
                    clearInterval(state.countDownInterval);
                    state.countDownInterval = null;
                }

                if (state.enableDynamicTime) {
                    targetWrapper.classList.remove('hidden');
                    const prediction = app.predictNextTime(u);

                    if (isCheckedInToday) {
                        targetWrapper.className = "mt-4 bg-indigo-500/30 rounded-lg p-2 backdrop-blur-sm border border-indigo-400/30 block"; 
                        targetLabel.textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô${prediction.label}`;
                        targetTimeDisplay.textContent = prediction.time;
                        countdownDisplay.textContent = prediction.penalty !== 0 ? `(‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ${prediction.penalty > 0 ? '-' : '+'}${Math.abs(prediction.penalty)} ‡∏ô‡∏≤‡∏ó‡∏µ)` : '‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥';
                        countdownDisplay.className = "text-xs text-white/80 font-normal mt-1";
                    } else {
                        targetWrapper.className = "mt-4 bg-white/10 rounded-lg p-2 backdrop-blur-sm block";
                        targetLabel.textContent = "‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
                        targetTimeDisplay.textContent = prediction.time;

                        const [h, m] = prediction.time.split(':').map(Number);
                        const targetDate = new Date();
                        targetDate.setHours(h, m, 0, 0);

                        const updateCountdown = () => {
                            const now = new Date();
                            const diff = targetDate - now;
                            if (diff > 0) {
                                const hours = Math.floor(diff / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                                countdownDisplay.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${hours}‡∏ä‡∏°. ${minutes}‡∏ô. ${seconds}‡∏ß‡∏¥.`;
                                countdownDisplay.className = "text-xs text-yellow-300 font-bold mt-1";
                            } else {
                                const lateMins = Math.ceil(Math.abs(diff) / 60000);
                                countdownDisplay.textContent = `‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${lateMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                                countdownDisplay.className = "text-xs text-red-300 font-bold mt-1";
                            }
                        };
                        updateCountdown(); 
                        state.countDownInterval = setInterval(updateCountdown, 1000);
                    }
                } else {
                    targetWrapper.classList.add('hidden');
                }

                const headerBg = document.getElementById('user-header-bg');
                const statusIcon = document.getElementById('user-status-icon');
                const statusTitle = document.getElementById('user-status-title');
                const penaltyCard = document.getElementById('user-penalty-card');
                const warning = document.getElementById('user-no-target-warning');
                
                if (state.testMode && !isCheckedInToday) {
                    document.getElementById('user-status-message').textContent = 'üß™ Test Mode Active (Bypass GPS)';
                }

                const sysStatus = app.getSystemStatus();
                if (!sysStatus.active) {
                    headerBg.className = 'bg-slate-500 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                    statusIcon.setAttribute('data-lucide', 'moon');
                    statusTitle.textContent = '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î';
                    document.getElementById('user-status-message').textContent = sysStatus.label;
                    penaltyCard.classList.add('hidden');
                    warning.classList.add('hidden');
                    app.stopGPS();
                    if (state.countDownInterval) { clearInterval(state.countDownInterval); state.countDownInterval = null; }
                    targetWrapper.classList.add('hidden');
                    lucide.createIcons();
                    return; 
                }

                if (isCheckedInToday) {
                    let status = u.status;
                    let penalty = u.penalty;
                    let lateMinutes = u.lateMinutes;
                    if (!status && u.checkInTime) {
                         const checkInDate = u.checkInTime.toDate ? u.checkInTime.toDate() : new Date(u.checkInTime);
                         const res = app.calculateLateStatus(checkInDate, state.lateTime);
                         status = res.status; penalty = res.penalty; lateMinutes = res.lateMinutes;
                    }

                    if (status === 'late_mild') {
                        headerBg.className = 'bg-yellow-500 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'alert-circle'); statusTitle.textContent = '‡∏™‡∏≤‡∏¢ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢ ${lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else if (status === 'late_heavy') {
                        headerBg.className = 'bg-orange-500 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'alert-triangle'); statusTitle.textContent = '‡∏™‡∏≤‡∏¢ (‡∏°‡∏≤‡∏Å)';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢ ${lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else if (status === 'absent') {
                        headerBg.className = 'bg-red-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'x-circle'); statusTitle.textContent = '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else {
                        headerBg.className = 'bg-green-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'check-circle'); statusTitle.textContent = '‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                        penaltyCard.classList.add('hidden');
                    }
                } else {
                    headerBg.className = 'bg-indigo-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                    statusIcon.setAttribute('data-lucide', 'wifi'); statusTitle.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠';
                    penaltyCard.classList.add('hidden');
                }
                warning.classList.toggle('hidden', !!state.targetLocation);
                
                const peerListEl = document.getElementById('user-peer-list');
                const peers = state.rosterList.filter(r => {
                    const user = state.usersList.find(u => u.id === r.assignedUid);
                    return user && app.isUserCheckedInToday(user); 
                }).map(r => {
                    const user = state.usersList.find(u => u.id === r.assignedUid);
                    return { ...r, checkInTime: user.checkInTime, status: user.status };
                });

                peers.sort((a, b) => {
                    const timeA = a.checkInTime ? (a.checkInTime.toDate ? a.checkInTime.toDate() : new Date(a.checkInTime)) : 0;
                    const timeB = b.checkInTime ? (b.checkInTime.toDate ? b.checkInTime.toDate() : new Date(b.checkInTime)) : 0;
                    return timeA - timeB;
                });

                if (peers.length === 0) {
                    peerListEl.innerHTML = '<p class="text-xs text-slate-400 text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
                } else {
                    peerListEl.innerHTML = peers.map(p => {
                        const timeStr = app.formatTime(p.checkInTime).split(' ')[1];
                        let statusColor = 'bg-green-100 text-green-600';
                        if (p.status?.includes('late')) statusColor = 'bg-yellow-100 text-yellow-600';
                        if (p.status === 'absent') statusColor = 'bg-red-100 text-red-600';

                        return `
                        <div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0 text-sm">
                            <span class="text-slate-700 font-medium">${p.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs ${statusColor} px-1.5 py-0.5 rounded">${p.status === 'on_time' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡∏™‡∏≤‡∏¢'}</span>
                                <span class="text-slate-400 font-mono text-xs">${timeStr}</span>
                            </div>
                        </div>`;
                    }).join('');
                }
                
                lucide.createIcons();
            },

            routeUserDashboard: () => {
                document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
                document.getElementById('global-admin-btn').style.display = 'flex';
                if (state.myUserData) {
                    document.getElementById('view-user_approved').style.display = 'flex';
                    app.startGPS();
                    app.updateUserDashboardUI();
                } else if (state.myPendingRequest) {
                    document.getElementById('view-user_pending').style.display = 'flex';
                    document.getElementById('pending-name-display').textContent = state.myPendingRequest.name;
                    app.stopGPS();
                } else {
                    document.getElementById('view-user_register').style.display = 'flex';
                    app.stopGPS();
                }
                lucide.createIcons();
            },

            checkAndRouteUser: () => {
                const adminVisible = document.getElementById('view-admin_dashboard').style.display !== 'none';
                const adminLoginVisible = document.getElementById('view-admin_login').style.display !== 'none';
                if (!adminVisible && !adminLoginVisible) app.routeUserDashboard();
            },

            renderUserRegisterList: () => {
                const selectEl = document.getElementById('register-name-select');
                if(!selectEl) return;
                const availableNames = state.rosterList.filter(r => !r.assignedUid);
                selectEl.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>' + 
                    availableNames.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            },

            renderAdminRequests: () => {
                const container = document.getElementById('admin-pending-wrapper');
                const listEl = document.getElementById('admin-pending-list');
                const countEl = document.getElementById('pending-count');
                if(countEl) countEl.textContent = state.pendingRequests.length;
                
                if (state.pendingRequests.length > 0) {
                    container.classList.remove('hidden');
                    listEl.innerHTML = state.pendingRequests.map(req => `
                        <div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
                            <div><div class="font-bold text-slate-800">${req.name}</div><div class="text-[10px] text-slate-400">UID: ${req.uid.substring(0,6)}...</div></div>
                            <div class="flex gap-2"><button onclick="app.handleRejectUser('${req.id}')" class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded hover:bg-red-100 hover:text-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button><button onclick="app.handleApproveUser({uid:'${req.uid}', name:'${req.name}', rosterId:'${req.rosterId || ''}'})" class="px-2 py-1 bg-indigo-600 text-white text-xs rounded shadow hover:bg-indigo-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div>
                        </div>`).join('');
                } else { 
                    container.classList.add('hidden'); 
                }
                lucide.createIcons();
            },

            renderAdminHistory: () => {
                const container = document.getElementById('history-container');
                if (state.historyList.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 text-sm py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</p>'; return; }
                container.innerHTML = state.historyList.map(h => {
                    const dateParts = h.dateStr.split('-');
                    const dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
                    
                    const usersHtml = h.records && h.records.length > 0 ? h.records.map((r, index) => {
                        const isCleared = r.cleared || false;
                        const clearedClass = isCleared ? 'cleared-record' : '';
                        const checkIcon = isCleared ? 'check-square' : 'square';
                        const checkColor = isCleared ? 'text-green-600' : 'text-slate-300';
                        
                        return `
                        <div class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm items-center transition-all duration-200 ${clearedClass}">
                            <div class="flex gap-3 items-center flex-1">
                                <button onclick="app.handleToggleHistoryClear('${h.id}', ${index})" class="${checkColor} hover:text-green-500 transition">
                                    <i data-lucide="${checkIcon}" class="w-5 h-5"></i>
                                </button>
                                <div class="flex flex-col">
                                    <span class="text-slate-700 font-medium record-name">${r.name}</span>
                                    <span class="text-[10px] text-slate-400">${(r.penalty && r.penalty !== '-' && r.penalty !== 'undefined') ? r.penalty : '‡∏õ‡∏Å‡∏ï‡∏¥'}</span>
                                </div>
                            </div>
                            <span class="text-slate-500 font-mono text-xs">${(r.time && r.time.includes(' ')) ? r.time.split(' ')[1] : '-'}</span>
                        </div>`;
                    }).join('') : '<div class="text-center text-slate-400 text-xs py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';

                    return `
                    <div class="history-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 flex justify-between items-center bg-slate-50">
                            <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="this.parentElement.parentElement.classList.toggle('active')">
                                <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg font-bold text-xs flex flex-col items-center min-w-[3rem]">
                                    <span>${dateObj.getDate()}</span><span class="text-[9px] uppercase">${dateObj.toLocaleDateString('en-US', {month:'short'})}</span>
                                </div>
                                <div class="font-bold text-slate-700">${dateStr}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-full cursor-pointer" onclick="this.parentElement.parentElement.parentElement.classList.toggle('active')">${h.count} ‡∏Ñ‡∏ô</span>
                                <button onclick="app.handleDeleteHistory('${h.id}')" class="text-slate-400 hover:text-red-500 p-1" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-down" class="chevron-icon w-4 h-4 text-slate-400 transition-transform duration-300 cursor-pointer" onclick="this.parentElement.parentElement.parentElement.classList.toggle('active')"></i>
                            </div>
                        </div>
                        <div class="history-content bg-white px-4"><div class="py-3">${usersHtml}</div></div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            },

            // --- 5. DATA SYNC & ADMIN LOGIC ---
            syncData: () => {
                if (!state.currentUser) return;
                
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), (snap) => {
                    if(snap.exists()) {
                        const data = snap.data();
                        state.targetLocation = data.location || null;
                        state.systemDate = data.currentDate || null;
                        state.lateTime = data.lateTime || "07:00";
                        state.checkInRadius = data.radius || 100;
                        state.testMode = data.testMode || false;
                        state.systemStatusOverride = data.systemStatusOverride || null; 
                        state.enableDynamicTime = data.enableDynamicTime || false; // NEW
                        state.maxPenaltyMinutes = data.maxPenaltyMinutes || 5; // NEW
                        
                        const el = document.getElementById('admin-location-status');
                        if (state.targetLocation) {
                            el.textContent = `${state.targetLocation.lat.toFixed(5)}, ${state.targetLocation.lng.toFixed(5)}`;
                        } else {
                            el.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
                        }
                        
                        document.getElementById('admin-late-time-input').value = state.lateTime;
                        document.getElementById('admin-radius-input').value = state.checkInRadius;
                        document.getElementById('admin-testmode-toggle').checked = state.testMode;
                        document.getElementById('admin-dynamic-time-toggle').checked = state.enableDynamicTime;
                        document.getElementById('admin-max-penalty-input').value = state.maxPenaltyMinutes;
                        
                        const status = app.getSystemStatus();
                        const badge = document.getElementById('admin-system-status-badge');
                        badge.textContent = status.label;
                        badge.className = `text-xs font-bold px-2 py-1 rounded bg-slate-100 ${status.color}`;

                        // Update Rules Modal UI
                        const rulesTimeEl = document.getElementById('rules-base-time');
                        if(rulesTimeEl) rulesTimeEl.textContent = state.lateTime;
                        
                        const rulesMaxEl = document.getElementById('rules-max-penalty');
                        if(rulesMaxEl) rulesMaxEl.textContent = state.maxPenaltyMinutes;
                        
                        ['auto', 'open', 'closed'].forEach(mode => {
                            const btn = document.getElementById(`btn-mode-${mode}`);
                            const isActive = (mode === 'auto' && state.systemStatusOverride === null) || (mode === state.systemStatusOverride);
                            if (isActive) {
                                btn.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-1');
                            } else {
                                btn.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-1');
                            }
                        });

                        if (document.getElementById('view-admin_dashboard').style.display !== 'none') {
                            app.checkAndRunAutoArchive();
                        }
                        app.updateUserDashboardUI(); 
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { 
                            currentDate: app.getTodayStr(), location: null, lateTime: "07:00", radius: 100, testMode: false, systemStatusOverride: null
                        });
                    }
                });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    list.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                    state.rosterList = list;
                    app.renderAdminToday();
                    app.renderUserRegisterList();
                    app.updateUserDashboardUI(); 
                });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.usersList = list;
                    state.myUserData = list.find(u => u.id === state.currentUser.uid) || null;
                    app.renderAdminToday();
                    app.checkAndRouteUser();
                });

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.pendingRequests = list;
                    state.myPendingRequest = list.find(r => r.id === state.currentUser.uid) || null;
                    app.renderAdminRequests();
                    app.checkAndRouteUser();
                });

                const historyQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'history'), orderBy('dateStr', 'desc'), limit(30));
                onSnapshot(historyQuery, (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.historyList = list;
                    app.renderAdminHistory();
                });
            },

            checkAndRunAutoArchive: async () => {
                const todayStr = app.getTodayStr();
                const systemDate = state.systemDate;
                if (systemDate && systemDate < todayStr) {
                    const statusEl = document.getElementById('auto-archive-status');
                    statusEl.classList.remove('hidden');
                    try {
                        // Check for Weekend
                        const dateParts = systemDate.split('-');
                        const d = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
                        const dayNum = d.getDay();
const isWeekend = dayNum === 0 || dayNum === 6;
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const isForcedClosed = state.systemStatusOverride === 'closed';

                        const historyRecords = state.rosterList.map(rosterItem => {
                            const user = state.usersList.find(u => u.id === rosterItem.assignedUid);
                            const isCheckedIn = user && user.checkInDate === systemDate;
                            
                            let status = 'absent';
                            let penalty = '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô'; 
                            let timeStr = '-';
                            let cleared = false;

                            // Calculate next day penalty adjustment if enabled
                            let newPenaltyMinutes = user ? (user.penaltyMinutes || 0) : 0;

                            if (isWeekend || isForcedClosed) { 
    status = 'holiday';
    penalty = '-';
    // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Penalty) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ
} else if (isCheckedIn) {
                                timeStr = app.formatTime(user.checkInTime);
                                status = user.status || 'unknown';
                                penalty = (user.penalty && user.penalty !== 'undefined') ? user.penalty : '-';
                                cleared = user.clearedToday || false; 
                                
                                // FIXED: Logic to respect 'cleared' flag
                                if (cleared) {
                                    // If cleared, treat as if 'on_time' (or maintain) -> Let's give benefit: reduce time if possible, or stay same.
                                    // Policy: If cleared, do NOT increase penalty. If status is on_time, reduce.
                                    if (status === 'on_time') {
                                        newPenaltyMinutes = Math.max(0, newPenaltyMinutes - 2);
                                    }
                                    // If late/absent but cleared -> No change to penalty.
                                } else {
                                    // Normal Logic
                                    if (status === 'on_time') {
                                        newPenaltyMinutes = Math.max(0, newPenaltyMinutes - 2);
                                    } else if (status.includes('late')) {
                                        newPenaltyMinutes = Math.min(state.maxPenaltyMinutes, newPenaltyMinutes + 3);
                                    }
                                }
                            } else if (rosterItem.manualStatus && rosterItem.manualStatusDate === systemDate) {
                                status = rosterItem.manualStatus;
                                if (status === 'sick_leave') penalty = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢';
                                else if (status === 'personal_leave') penalty = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
                                else if (status === 'other') penalty = '-'; // Add this
                                // Leave -> No penalty change
                            } else {
                                // Absent (‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
                                newPenaltyMinutes = Math.min(state.maxPenaltyMinutes, newPenaltyMinutes + 5);
                                
                                // ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏¢‡∏∞‡∏™‡∏∞‡∏™‡∏° 20 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î
                                if (user) {
                                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.id), {
                                        penaltyMinutes: newPenaltyMinutes,
                                        trashDebt: increment(20) // <--- ‡∏ö‡∏ß‡∏Å 20 ‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á
                                    });
                                }
                            }

                            // Update User's accumulated penalty for next day if Dynamic Mode ON
                            if (state.enableDynamicTime && user) {
                                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.id), {
                                    penaltyMinutes: newPenaltyMinutes
                                });
                            }

                            return { 
                                name: rosterItem.name, 
                                time: timeStr, 
                                status: status, 
                                penalty: penalty, 
                                cleared: cleared 
                            };
                        });

                        const historyData = {
                            dateStr: systemDate, timestamp: serverTimestamp(),
                            count: historyRecords.filter(r => r.status !== 'absent' && r.status !== 'sick_leave' && r.status !== 'personal_leave' && r.status !== 'holiday' && r.status !== 'other').length,
                            records: historyRecords
                        };
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', `day_${systemDate}`), historyData);
                        
                        // FIXED: Don't reset if user already checked in TODAY
                        state.usersList.forEach(async (u) => {
                            if (u.checkInDate === todayStr) return; // SKIP RESET for today's early birds!

                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                                checkedIn: false, checkInTime: null, checkInDate: null, status: null, penalty: null, lateMinutes: null, clearedToday: null
                            });
                        });
                        
                        state.rosterList.forEach(async (r) => {
                            if (r.manualStatus) {
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', r.id), {
                                    manualStatus: deleteField(),
                                    manualStatusDate: deleteField()
                                });
                            }
                        });

                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { currentDate: todayStr });
                    } catch (e) { console.error("Auto Archive Error", e); } 
                    finally { setTimeout(() => statusEl.classList.add('hidden'), 3000); }
                }
            },

            renderAdminToday: () => {
                const listEl = document.getElementById('today-users-list');
                const now = new Date();
                const todayStr = app.getTodayStr();
                
                const unifiedList = state.rosterList.map(rosterItem => {
                    const user = state.usersList.find(u => u.id === rosterItem.assignedUid);
                    const isCheckedIn = user && app.isUserCheckedInToday(user);
                    
                    let status = 'not_arrived';
                    let penalty = '-';
                    let lateMinutes = 0;
                    let timeStr = '-';
                    let checkInTimeVal = Infinity;
                    let clearedToday = false;
                    let nextTarget = { time: state.lateTime, label: '‡∏õ‡∏Å‡∏ï‡∏¥', penalty: 0 };
                    let currentPenalty = 0;

                    // Determine Target Time for this user (Current)
                    let userLateTime = state.lateTime;
                    if (state.enableDynamicTime && user) {
                        currentPenalty = user.penaltyMinutes || 0;
                        if (currentPenalty > 0) {
                            const [h, m] = state.lateTime.split(':').map(Number);
                            const d = new Date();
                            d.setHours(h, m - currentPenalty, 0, 0);
                            userLateTime = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                        }
                        // Calculate Next Target
                        nextTarget = app.predictNextTime(user);
                    }

                    const sysStatus = app.getSystemStatus(); // 1. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô

if (rosterItem.manualStatus && rosterItem.manualStatusDate === todayStr) {
    status = rosterItem.manualStatus;
    if (status === 'sick_leave') penalty = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢';
    else if (status === 'personal_leave') penalty = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
    else if (status === 'other') penalty = '-';
} 
// 2. ‡πÅ‡∏ó‡∏£‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏ï‡∏≤‡∏°)
else if (!sysStatus.active) {
    status = 'holiday';
    penalty = '-';
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
    if (isCheckedIn) {
         timeStr = app.formatTime(user.checkInTime).split(' ')[1];
    }
}
// 3. ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
else if (isCheckedIn) {
    timeStr = app.formatTime(user.checkInTime).split(' ')[1];
    status = user.status;
                        penalty = user.penalty;
                        lateMinutes = user.lateMinutes;
                        clearedToday = user.clearedToday || false;
                        
                        if (user.checkInTime) {
                            checkInTimeVal = user.checkInTime.toDate ? user.checkInTime.toDate().getTime() : new Date(user.checkInTime).getTime();
                        }
                        
                        if (!status && user.checkInTime) {
                             const cd = user.checkInTime.toDate ? user.checkInTime.toDate() : new Date(user.checkInTime);
                             const res = app.calculateLateStatus(cd, state.lateTime);
                             status = res.status; penalty = res.penalty; lateMinutes = res.lateMinutes;
                        }
                    } else {
                        // Not checked in yet
                        const sysStatus = app.getSystemStatus();
                        if (!sysStatus.active) {
                             status = 'holiday';
                             penalty = '-';
                        } else {
                            // Calc based on USER SPECIFIC TIME
                            const res = app.calculateLateStatus(now, userLateTime);
                            if (res.status === 'absent') {
    status = 'absent';
    // FIXED: Update text to match the new rules
    penalty = '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô';
    lateMinutes = res.lateMinutes;
}
                        }
                        
                        if (user) {
                            clearedToday = user.clearedToday || false;
                        }
                    }

                    let trashDebt = (user && user.trashDebt) ? user.trashDebt : 0; 

                    // 2. ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ trashDebt ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                    return { ...rosterItem, status, penalty, lateMinutes, timeStr, isCheckedIn, checkInTimeVal, clearedToday, nextTarget, currentPenalty, trashDebt };
                });

                unifiedList.sort((a, b) => {
                    if (a.isCheckedIn && !b.isCheckedIn) return -1;
                    if (!a.isCheckedIn && b.isCheckedIn) return 1;
                    if (a.isCheckedIn && b.isCheckedIn) return a.checkInTimeVal - b.checkInTimeVal;
                    return a.name.localeCompare(b.name, 'th');
                });

                const checkedInCount = unifiedList.filter(u => u.isCheckedIn).length;
                document.getElementById('today-checked-in').textContent = checkedInCount;
                document.getElementById('today-total').textContent = unifiedList.length;

                if (unifiedList.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-slate-400 py-8 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                    return;
                }
                
                listEl.innerHTML = unifiedList.map(u => {
                    let statusBadge = '', bgColor = 'bg-white';
                    
                    if (u.status === 'on_time') { 
                        statusBadge = `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded border border-green-200">‡∏õ‡∏Å‡∏ï‡∏¥</span>`; 
                        bgColor = 'bg-green-50/50';
                    } else if (u.status === 'late_mild') { 
                        statusBadge = `<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200">‡∏™‡∏≤‡∏¢ ${u.lateMinutes}‡∏ô. (${u.penalty})</span>`; 
                        bgColor = 'bg-yellow-50/50';
                    } else if (u.status === 'late_heavy') { 
                        statusBadge = `<span class="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded border border-orange-200">‡∏™‡∏≤‡∏¢ ${u.lateMinutes}‡∏ô. (${u.penalty})</span>`; 
                        bgColor = 'bg-orange-50/50';
                    } else if (u.status === 'absent') { 
                        statusBadge = `<span class="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded border border-red-200">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${u.penalty})</span>` 
                        bgColor = 'bg-red-50/50';
                    } else if (u.status === 'sick_leave') {
                        statusBadge = `<span class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded border border-blue-200">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</span>`;
                        bgColor = 'bg-blue-50/50';
                    } else if (u.status === 'personal_leave') {
                        statusBadge = `<span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">üíº ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>`;
                        bgColor = 'bg-purple-50/50';
                    } else if (u.status === 'other') { 
                        statusBadge = `<span class="text-[10px] bg-slate-200 text-slate-700 px-1.5 py-0.5 rounded border border-slate-300">-</span>`;
                        bgColor = 'bg-slate-100';
                    } else if (u.status === 'holiday') {
                        statusBadge = `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</span>`;
                        bgColor = 'bg-white';
                    } else {
                        statusBadge = `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤</span>`;
                    }

                    const icon = u.assignedUid ? (u.isCheckedIn ? 'check' : 'smartphone') : 'user';
                    const iconColor = u.isCheckedIn ? 'text-green-600' : 'text-slate-400';
                    const iconBg = u.isCheckedIn ? 'bg-green-100' : 'bg-slate-100';

                    let actionBtn = '';
                    
                    let clearBtn = '';
                    if ((u.status !== 'on_time' && u.status !== 'not_arrived' && u.status !== 'holiday') && u.assignedUid) { 
                         const isCleared = u.clearedToday;
                         const checkIcon = isCleared ? 'check-square' : 'square';
                         const checkColor = isCleared ? 'text-green-600' : 'text-slate-300';
                         clearBtn = `<button onclick="app.handleToggleTodayPenaltyClear('${u.assignedUid}', ${isCleared})" class="${checkColor} hover:text-green-500 transition mr-2" title="‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏ó‡∏©‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ)"><i data-lucide="${checkIcon}" class="w-5 h-5"></i></button>`;
                    }

                    // FIXED: Show Reset Button if ANY penalty exists (Current OR Predicted)
                    let resetTimeBtn = '';
                    if ((u.currentPenalty > 0 || u.nextTarget.penalty > 0) && u.assignedUid) {
                        resetTimeBtn = `<button onclick="app.handleResetUserPenalty('${u.assignedUid}', '${u.name}')" class="text-orange-400 hover:text-green-500 p-2" title="‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏ó‡∏©‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset)"><i data-lucide="history" class="w-4 h-4"></i></button>`;
                    }

 let redeemBtn = '';
                    if (u.assignedUid && u.trashDebt > 0) {
                        redeemBtn = `<button onclick="app.openRedeemModal('${u.assignedUid}', '${u.name}', ${u.trashDebt})" class="text-orange-500 hover:text-green-600 p-2 relative" title="‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏¢‡∏∞‡∏™‡∏∞‡∏™‡∏°">
                            <i data-lucide="trash" class="w-4 h-4"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">${u.trashDebt}</span>
                        </button>`;
                    }

                    // 2. ‡∏£‡∏ß‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÉ‡∏ô actionBtn (‡πÉ‡∏™‡πà redeemBtn ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î)
                    if (u.isCheckedIn) {
                        actionBtn = `${redeemBtn}${clearBtn}${resetTimeBtn}<button onclick="app.handleUnpairUser('${u.assignedUid}', '${u.name}', '${u.id}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"><i data-lucide="unlink" class="w-4 h-4"></i></button>`;
                    } else {
                        actionBtn = `
                            ${redeemBtn}
                            ${clearBtn}
                            ${resetTimeBtn}
                            <button onclick="app.handleOpenStatusModal('${u.id}', '${u.status}', '${u.name}')" class="text-slate-300 hover:text-indigo-500 p-2" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><i data-lucide="flag" class="w-4 h-4"></i></button>
                            ${!u.assignedUid ? `<button onclick="app.handleDeleteRoster('${u.id}', '${u.name}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : `<button onclick="app.handleUnpairUser('${u.assignedUid}', '${u.name}', '${u.id}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà"><i data-lucide="unlink" class="w-4 h-4"></i></button>`}
                        `;
                    }

                    const clearedClass = u.clearedToday ? 'cleared-record' : '';

                    // Next Time Display
                    let nextTimeDisplay = '';
                    if (state.enableDynamicTime && u.assignedUid) {
                        nextTimeDisplay = `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-1">
                                            <i data-lucide="calendar-clock" class="w-3 h-3 text-slate-300"></i>
                                            <span class="${u.nextTarget.penalty > 0 ? 'text-orange-500' : ''}">${u.nextTarget.label}: ${u.nextTarget.time}</span>
                                           </div>`;
                    }

                    return `
                    <div class="flex justify-between items-center p-3 ${bgColor} ${clearedClass} hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="${iconBg} p-2 rounded-full ${iconColor}"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm ${u.clearedToday ? 'line-through text-green-700' : ''}">${u.name}</div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-xs font-mono text-slate-500">${u.timeStr}</span>
                                    ${statusBadge}
                                </div>
                                ${nextTimeDisplay}
                            </div>
                        </div>
                        <div class="flex gap-1 items-center">
                            ${actionBtn}
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            },

            handleToggleTodayPenaltyClear: async (uid, currentVal) => {
                if(!uid) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        clearedToday: !currentVal
                    });
                } catch(e) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },

            handleOpenStatusModal: (rosterId, currentStatus, name) => {
                state.editingRosterId = rosterId;
                document.getElementById('modal-status-name').textContent = name;
                document.getElementById('modal-status-edit').classList.remove('hidden');
            },

            handleSaveStatus: async (status) => {
                if (!state.editingRosterId) return;
                const todayStr = app.getTodayStr();
                try {
                    if (status) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', state.editingRosterId), {
                            manualStatus: status,
                            manualStatusDate: todayStr
                        });
                    } else {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', state.editingRosterId), {
                            manualStatus: deleteField(),
                            manualStatusDate: deleteField()
                        });
                    }
                    document.getElementById('modal-status-edit').classList.add('hidden');
                } catch(e) { alert('Error: ' + e.message); }
            },

            handleSetRadius: async () => {
                const val = parseInt(document.getElementById('admin-radius-input').value);
                if (!val || val <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { radius: val });
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            },

            handleSetLateTime: async () => {
                const val = document.getElementById('admin-late-time-input').value;
                if(!val) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { lateTime: val });
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            },
			
			// --- ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å handleSetLateTime ---

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)
            handleToggleDynamicTime: async (isChecked) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { enableDynamicTime: isChecked });
                } catch (e) { console.error(e); }
            },

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Set (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)
            handleSetMaxPenalty: async () => {
                const val = parseInt(document.getElementById('admin-max-penalty-input').value);
                if (isNaN(val) || val < 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { maxPenaltyMinutes: val });
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } catch (e) { alert('Error: ' + e.message); }
            },
            
            // -------------------------------------

            handleToggleTestMode: async (isChecked) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { testMode: isChecked });
            },

            handleSetSystemOverride: async (mode) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { systemStatusOverride: mode });
            },

            handleDeleteHistory: async (id) => {
                if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', id));
                } catch(e) { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },
            
            handleToggleHistoryClear: async (historyId, recordIndex) => {
                const historyDoc = state.historyList.find(h => h.id === historyId);
                if (!historyDoc || !historyDoc.records) return;
                
                const newRecords = [...historyDoc.records];
                newRecords[recordIndex].cleared = !newRecords[recordIndex].cleared;
                
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', historyId), {
                        records: newRecords
                    });
                } catch(e) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },

            handleClearAllHistory: async () => {
                if(!confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) return;
                const password = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:');
                if (!password || password.trim() !== ADMIN_PIN) return alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');

                try {
                    const promises = state.historyList.map(h =>
                        deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', h.id))
                    );
                    await Promise.all(promises);
                    alert('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } catch(e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }
            },

            handleAddRoster: async () => {
                const text = document.getElementById('roster-textarea').value;
                if (!text.trim()) return;
                const names = text.split('\n').map(n => n.trim()).filter(n => n);
                try {
                    const batchPromises = names.map(name => 
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), {
                            name: name, assignedUid: null, createdAt: serverTimestamp()
                        })
                    );
                    await Promise.all(batchPromises);
                    document.getElementById('roster-textarea').value = '';
                    document.getElementById('modal-add-roster').classList.add('hidden');
                    alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${names.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                } catch(e) { alert('Error: ' + e.message); }
            },

            handleDeleteRoster: async (id, name) => {
                if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', id));
                }
            },

            handleUnpairUser: async (uid, name, rosterId) => {
                if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà)`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', rosterId), { assignedUid: null });
                }
            },

            handleRequestAccess: async () => {
                const selectEl = document.getElementById('register-name-select');
                const rosterId = selectEl.value;
                if (!rosterId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                const rosterItem = state.rosterList.find(r => r.id === rosterId);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', state.currentUser.uid), { 
                    name: rosterItem.name, uid: state.currentUser.uid, rosterId: rosterId, requestedAt: serverTimestamp() 
                });
                alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            },

            handleAutoCheckIn: async () => {
                const sysStatus = app.getSystemStatus();
                if (!sysStatus.active) return;

                // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (state.isProcessingCheckIn || (state.myUserData && state.myUserData.checkedIn)) return;

                const todayStr = app.getTodayStr();
                
                if (state.myUserData && !state.myUserData.checkedIn) {
                    // 2. ‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥
                    state.isProcessingCheckIn = true; 
                    
                    document.getElementById('user-status-message').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                    
                    try {
                        const now = new Date();
                        const result = app.calculateLateStatus(now, state.lateTime);
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', state.currentUser.uid), {
                            checkedIn: true, 
                            checkInTime: serverTimestamp(), 
                            checkInDate: todayStr, 
                            status: result.status, 
                            penalty: result.penalty, 
                            lateMinutes: result.lateMinutes,
                            trashDebt: increment(result.trashScore)
                        });
                        
                        // ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
                    } catch (error) {
                        console.error("Check-in Error:", error);
                        // ‡∏ñ‡πâ‡∏≤ Error ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
                        state.isProcessingCheckIn = false;
                        document.getElementById('user-status-message').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    }
                }
            },

            handleResetIdentity: async () => { if (confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?')) { await signOut(auth); window.location.reload(); } },
            
            checkAdminLogin: () => { 
                const input = document.getElementById('admin-pin-input');
                if (input.value.trim() === ADMIN_PIN) {
                    router.navigate('admin_dashboard');
                    input.value = '';
                    app.checkAndRunAutoArchive();
                } else {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');
                    input.value = ''; // Clear input on error
                }
            },

            handleSetTargetLocation: () => {
                if ('geolocation' in navigator) navigator.geolocation.getCurrentPosition(async (pos) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { location: { lat: pos.coords.latitude, lng: pos.coords.longitude } });
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                });
            },
            
            handleApproveUser: async (req) => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', req.uid), { 
                        name: req.name, deviceId: req.uid, rosterId: req.rosterId,
                        checkedIn: false, checkInTime: null, checkInDate: null, status: null, penalty: null, lateMinutes: null, registeredAt: serverTimestamp() 
                    });
                    if (req.rosterId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', req.rosterId), { assignedUid: req.uid });
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.uid));
                } catch (e) { alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },
            
            handleRejectUser: async (reqId) => { if(confirm("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId)); },
            
            // NEW: Function to reset individual user's penalty time
            handleResetUserPenalty: async (uid, name) => {
                // FIXED: ‡πÉ‡∏ä‡πâ state.lateTime ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 07:50
                if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á "${name}" ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (${state.lateTime}) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n(‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏ó‡∏©‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏∞‡∏™‡∏° ‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏ó‡∏©‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`)) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        penaltyMinutes: 0,
                        clearedToday: true // Also set cleared for today to prevent new penalty tonight
                    });
                    alert(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á ${name} ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${state.lateTime} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
                } catch(e) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
                }
            },

            // Replaced handleResetDay with handleFullReset for more comprehensive reset
            handleFullReset: async () => {
                // FIXED: ‡πÉ‡∏ä‡πâ state.lateTime ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 07:50
                if(!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö?\n\n1. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n2. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (${state.lateTime})\n3. ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)\n\n‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`)) return;
                
                const password = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:');
                if (!password || password.trim() !== ADMIN_PIN) return alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');

                // Show loading to indicate work in progress
                const loadingEl = document.getElementById('view-loading');
                if(loadingEl) {
                    loadingEl.style.display = 'flex';
                    loadingEl.querySelector('p').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö...';
                }

                try {
                    const todayStr = app.getTodayStr();

                    // 1. Reset Users (Check-in data AND Penalty minutes)
                    const promises = state.usersList.map(u => 
    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { 
        checkedIn: false, 
        checkInTime: null, 
        checkInDate: null, 
        status: null, 
        penalty: null, 
        lateMinutes: null,
        clearedToday: null,
        penaltyMinutes: 0,
        trashDebt: 0 // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á
    })
);
                    
                    // 2. Clear Roster Manual Status
                    const rosterPromises = state.rosterList.map(r => {
                        if (r.manualStatus) {
                            return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', r.id), {
                                manualStatus: deleteField(),
                                manualStatusDate: deleteField()
                            });
                        }
                        return Promise.resolve();
                    });

                    // 3. Delete Today's History (if exists) - To prevent duplicates/ghost data
                    const historyPromise = deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', `day_${todayStr}`));

                    // 4. Force Update System Date to Today
                    const systemPromise = updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { 
                        currentDate: todayStr 
                    });

                    await Promise.all([...promises, ...rosterPromises, historyPromise, systemPromise]);
                    
                    if(loadingEl) loadingEl.style.display = 'none'; // Hide loading
                    alert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                    // window.location.reload(); // Removed force reload
                } catch(e) {
                    console.error(e);
                    if(loadingEl) loadingEl.style.display = 'none';
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
                }
            },
			
			// ‡πÄ‡∏õ‡∏¥‡∏î Modal
            openRedeemModal: (uid, name, currentDebt) => {
                state.redeemTarget = { uid, currentDebt }; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                document.getElementById('redeem-user-name').textContent = name;
                document.getElementById('redeem-current-debt').textContent = currentDebt;
                document.getElementById('redeem-amount-input').value = '';
                document.getElementById('modal-redeem-trash').classList.remove('hidden');
                document.getElementById('redeem-amount-input').focus();
            },

            // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î
            handleRedeemSubmit: async () => {
                const amount = parseInt(document.getElementById('redeem-amount-input').value);
                if (!amount || amount <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                if (!state.redeemTarget) return;

                const { uid, currentDebt } = state.redeemTarget;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà)
                // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0
                const deductAmount = amount; 

                try {
                    // ‡πÉ‡∏ä‡πâ increment(-amount) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ñ‡πà‡∏≤
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                        trashDebt: increment(-deductAmount)
                    });
                    
                    document.getElementById('modal-redeem-trash').classList.add('hidden');
                    // alert(`‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏µ‡∏Å ${Math.max(0, currentDebt - deductAmount)} ‡∏ä‡∏¥‡πâ‡∏ô`);
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            }
        };

        window.app = app;
        window.router = router;
        app.init();
        lucide.createIcons();
    </script>
</body>
</html>
