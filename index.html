<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoCheck-In Pro (Roster)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .view { display: none; } 
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        .admin-float-btn {
            position: fixed; top: 1rem; right: 1rem; z-index: 50;
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 9999px;
            padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #475569;
            display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;
            cursor: pointer; border: 1px solid #e2e8f0;
        }
        .admin-float-btn:hover { background-color: #f1f5f9; transform: translateY(-1px); }
        .history-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .history-card.active .history-content { max-height: 500px; overflow-y: auto; }
        .history-card.active .chevron-icon { transform: rotate(180deg); }
        input[type="time"]::-webkit-calendar-picker-indicator { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <!-- ‡∏õ‡∏∏‡πà‡∏° Admin -->
    <button id="global-admin-btn" onclick="router.navigate('admin_login')" class="admin-float-btn">
        <i data-lucide="shield-check" class="w-4 h-4"></i> Admin
    </button>

    <!-- 1. LOADING VIEW -->
    <div id="view-loading" class="view min-h-screen flex items-center justify-center bg-white">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-slate-500 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
        </div>
    </div>

    <!-- 2. ADMIN LOGIN -->
    <div id="view-admin_login" class="view min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center relative">
            <h2 class="text-xl font-bold text-slate-800 mb-6">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="password" id="admin-pin-input" maxlength="4" class="w-full text-center text-3xl tracking-[1em] p-3 border-b-2 border-slate-200 mb-6 focus:outline-none focus:border-indigo-600" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus />
            <div class="flex gap-3">
                <button onclick="router.navigate('user_dashboard')" class="flex-1 bg-slate-100 p-3 rounded-xl text-slate-600">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onclick="app.checkAdminLogin()" class="flex-1 bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- 3. ADMIN DASHBOARD -->
    <div id="view-admin_dashboard" class="view min-h-screen bg-slate-50 pb-20">
        <header class="bg-indigo-900 text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
            <h1 class="font-bold flex items-center gap-2 text-lg"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Admin Dashboard</h1>
            <button onclick="router.navigate('user_dashboard')" class="opacity-80 hover:opacity-100"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <main class="max-w-3xl mx-auto p-4 space-y-6">
            <!-- Auto Archive Status -->
            <div id="auto-archive-status" class="hidden bg-blue-50 text-blue-700 px-4 py-3 rounded-xl text-sm border border-blue-100 flex items-center gap-2 animate-pulse">
                <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà...
            </div>

            <!-- TODAY CARD -->
            <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 p-5 text-white flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold">TODAY</span>
                            <span class="text-sm opacity-90" id="today-date-display">...</span>
                        </div>
                        <h2 class="text-2xl font-bold" id="today-day-name">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold"><span id="today-checked-in">0</span>/<span id="today-total">0</span></div>
                        <div class="text-xs opacity-80">‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                </div>
                
                <!-- Action Bar & Settings -->
                <div class="bg-indigo-50 p-4 border-b border-indigo-100 space-y-3">
                    <!-- Row 1: Location & Roster -->
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-indigo-600 flex flex-col gap-0.5">
                            <div class="flex items-center gap-1 font-bold">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠:
                            </div>
                            <span id="admin-location-status" class="font-mono text-[10px] bg-white px-1.5 py-0.5 rounded border border-indigo-100">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('modal-add-roster').classList.remove('hidden')" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-50 flex items-center gap-1">
                                <i data-lucide="users" class="w-3 h-3"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                            </button>
                            <button onclick="app.handleSetTargetLocation()" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-50">‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
                        </div>
                    </div>
                    
                    <!-- Row 2: Late Time -->
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-indigo-200 shadow-sm">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <i data-lucide="clock" class="w-4 h-4 text-orange-500"></i>
                            <span class="font-bold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="time" id="admin-late-time-input" class="border border-slate-300 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:border-indigo-500">
                            <button onclick="app.handleSetLateTime()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>

                    <!-- Row 3: Radius -->
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-indigo-200 shadow-sm">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <i data-lucide="ruler" class="w-4 h-4 text-blue-500"></i>
                            <span class="font-bold">‡∏£‡∏±‡∏®‡∏°‡∏µ (‡πÄ‡∏°‡∏ï‡∏£):</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="admin-radius-input" class="border border-slate-300 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:border-indigo-500 w-20 text-center" placeholder="100">
                            <button onclick="app.handleSetRadius()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>

                <div class="p-0">
                    <div id="today-users-list" class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto"></div>
                </div>
            </div>

            <!-- HISTORY -->
            <div>
                <div class="flex justify-between items-center mb-3 ml-1 mt-6">
                    <h3 class="font-bold text-slate-600 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    </h3>
                    <button onclick="app.handleClearAllHistory()" class="text-[10px] text-red-400 hover:text-red-600 hover:underline flex items-center gap-1">
                        <i data-lucide="trash" class="w-3 h-3"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
                <div id="history-container" class="space-y-3">
                    <p class="text-center text-slate-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>
            </div>

            <!-- PENDING -->
            <div id="admin-pending-wrapper" class="hidden mt-8">
                <h3 class="font-bold text-amber-600 mb-3 ml-1 flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (<span id="pending-count">0</span>)</h3>
                <div id="admin-pending-list" class="bg-amber-50 rounded-xl border border-amber-100 p-2 space-y-2"></div>
            </div>
        </main>
    </div>

    <!-- MODAL ADD ROSTER -->
    <div id="modal-add-roster" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <p class="text-sm text-slate-500 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏ä‡∏∑‡πà‡∏≠)</p>
            <textarea id="roster-textarea" rows="5" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-500" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ&#10;‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô&#10;‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô"></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('modal-add-roster').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="app.handleAddRoster()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-sm hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT STATUS -->
    <div id="modal-status-edit" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
            <p id="modal-status-name" class="text-sm text-slate-500 mb-4">...</p>
            <div class="space-y-2">
                <button onclick="app.handleSaveStatus('sick_leave')" class="w-full bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-bold hover:bg-blue-200">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</button>
                <button onclick="app.handleSaveStatus('personal_leave')" class="w-full bg-purple-100 text-purple-700 py-2 rounded-lg text-sm font-bold hover:bg-purple-200">üíº ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</button>
                <button onclick="app.handleSaveStatus(null)" class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg text-sm font-bold hover:bg-slate-200">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏Å‡∏ï‡∏¥)</button>
            </div>
            <button onclick="document.getElementById('modal-status-edit').classList.add('hidden')" class="mt-4 text-slate-400 text-xs hover:text-slate-600">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <!-- 4. USER APPROVED VIEW -->
    <div id="view-user_approved" class="view min-h-screen bg-slate-50 flex flex-col">
        <div id="user-header-bg" class="bg-indigo-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500">
            <div class="mt-4 mb-2 inline-block p-4 bg-white/20 rounded-full backdrop-blur-sm">
                <i id="user-status-icon" data-lucide="wifi" class="w-12 h-12"></i>
            </div>
            <h2 id="user-status-title" class="text-2xl font-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h2>
            <p id="user-status-message" class="text-white/80 text-sm mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS...</p>
        </div>
        <main class="flex-1 p-6 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between border-b border-slate-50 pb-3 mb-3">
                    <span class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    <span id="user-name-display" class="font-bold text-slate-800">...</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á</div>
                        <div id="user-distance-display" class="font-bold text-slate-800">-</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-slate-400">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</div>
                        <div id="user-time-display" class="font-bold text-slate-800">-</div>
                    </div>
                </div>
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                <div class="mt-3 pt-2 border-t border-slate-50 flex justify-between items-center text-[10px]">
                    <span class="text-slate-400">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</span>
                    <span class="font-mono text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded" id="user-current-coords">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤...</span>
                </div>
            </div>

            <div id="user-penalty-card" class="hidden bg-orange-50 border border-orange-200 p-5 rounded-2xl shadow-sm text-center animate-pulse">
                <h3 class="text-orange-800 font-bold flex items-center justify-center gap-2 mb-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢
                </h3>
                <p id="user-penalty-detail" class="text-orange-700 text-lg font-bold">...</p>
                <p id="user-penalty-sub" class="text-orange-600 text-xs mt-1">...</p>
            </div>

            <div id="user-no-target-warning" class="hidden text-center text-red-500 text-sm bg-red-50 p-3 rounded-lg">‚ö†Ô∏è Admin ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</div>
            <div class="text-center mt-8"><p class="text-[10px] text-slate-300" id="approved-device-uid">Device UID: ...</p></div>
        </main>
    </div>

    <!-- 5. USER PENDING VIEW -->
    <div id="view-user_pending" class="view min-h-screen bg-slate-100 flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center pt-12">
            <div class="bg-amber-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="clock" class="text-amber-500 w-10 h-10 animate-pulse"></i></div>
            <h2 class="text-xl font-bold text-slate-800">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
            <p class="text-slate-500 mt-2 mb-6">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
            <div class="bg-slate-50 p-3 rounded-lg mb-6 text-sm text-left">
                <div class="flex justify-between mb-1"><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠:</span> <span id="pending-name-display">...</span></div>
                <div class="flex justify-between"><span class="text-slate-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> <span class="text-amber-500 font-bold">Pending</span></div>
            </div>
            <div class="mt-8 pt-4 border-t border-slate-100 flex flex-col items-center">
                <button onclick="app.handleResetIdentity()" class="flex items-center gap-1 text-[10px] text-red-400 hover:text-red-600 hover:underline"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)</button>
            </div>
        </div>
    </div>

    <!-- 6. USER REGISTER VIEW -->
    <div id="view-user_register" class="view min-h-screen bg-white flex flex-col">
        <header class="bg-slate-900 text-white p-6 pt-16 rounded-b-3xl shadow-lg relative">
            <div class="mt-4 text-center">
                <i data-lucide="user-plus" class="w-12 h-12 mx-auto mb-4 opacity-90"></i>
                <h1 class="text-2xl font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h1>
                <p class="text-slate-400 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
        </header>
        <main class="flex-1 p-8 flex flex-col justify-center">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <select id="register-name-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-600 focus:outline-none transition appearance-none">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
                    </select>
                </div>
                <button onclick="app.handleRequestAccess()" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                <div class="text-center pt-4">
                    <p class="text-xs text-slate-400">‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠? ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin</p>
                </div>
            </div>
        </main>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, serverTimestamp, deleteDoc, query, orderBy, limit, addDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHmJ7M5qf20lKPTB9_aE2Ppa0-jTryuuI",
            authDomain: "programpp-91f08.firebaseapp.com",
            projectId: "programpp-91f08",
            storageBucket: "programpp-91f08.firebasestorage.app",
            messagingSenderId: "415403943738",
            appId: "1:415403943738:web:f56ec72de49f81f0315203",
            measurementId: "G-W19QNQQR25"
        };
        const appId = 'default-app-id';
        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);
        const ADMIN_PIN = "2741";

        const state = {
            currentUser: null,
            targetLocation: null,
            lateTime: "07:00",
            checkInRadius: 100,
            usersList: [],
            rosterList: [], // List of all names
            pendingRequests: [],
            historyList: [],
            myUserData: null,
            myPendingRequest: null,
            gpsWatchId: null,
            systemDate: null,
            editingRosterId: null // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
        };

        const router = {
            navigate: (viewName) => {
                if (viewName === 'user_dashboard') { app.routeUserDashboard(); return; }
                document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
                const target = document.getElementById(`view-${viewName}`);
                if(target) {
                    target.style.display = target.classList.contains('flex') ? 'flex' : 'block';
                    lucide.createIcons();
                }
                const adminBtn = document.getElementById('global-admin-btn');
                if (viewName.startsWith('admin_') || viewName === 'loading') {
                    adminBtn.style.display = 'none';
                } else {
                    adminBtn.style.display = 'flex';
                }
            }
        };

        const app = {
            init: () => {
                router.navigate('loading');
                app.updateTodayDateDisplay();
                onAuthStateChanged(auth, (user) => {
                    state.currentUser = user;
                    if (user) {
                        const uidEl = document.getElementById('approved-device-uid');
                        if(uidEl) uidEl.textContent = `Device UID: ${user.uid.substring(0, 8)}...`;
                        app.syncData();
                    } else {
                        app.signIn();
                    }
                });
            },

            signIn: async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } },

            updateTodayDateDisplay: () => {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('today-date-display').textContent = now.toLocaleDateString('th-TH', options);
                document.getElementById('today-day-name').textContent = now.toLocaleDateString('th-TH', { weekday: 'long' });
            },

            getTodayStr: () => { return new Date().toLocaleDateString('en-CA'); },

            syncData: () => {
                if (!state.currentUser) return;
                
                // 1. Settings
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), (snap) => {
                    if(snap.exists()) {
                        const data = snap.data();
                        state.targetLocation = data.location || null;
                        state.systemDate = data.currentDate || null;
                        state.lateTime = data.lateTime || "07:00";
                        state.checkInRadius = data.radius || 100;
                        
                        const el = document.getElementById('admin-location-status');
                        if (state.targetLocation) {
                            el.textContent = `${state.targetLocation.lat.toFixed(5)}, ${state.targetLocation.lng.toFixed(5)}`;
                        } else {
                            el.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
                        }
                        
                        document.getElementById('admin-late-time-input').value = state.lateTime;
                        document.getElementById('admin-radius-input').value = state.checkInRadius;
                        if (document.getElementById('view-admin_dashboard').style.display !== 'none') {
                            app.checkAndRunAutoArchive();
                        }
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { 
                            currentDate: app.getTodayStr(), location: null, lateTime: "07:00", radius: 100
                        });
                    }
                });

                // 2. Roster
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    list.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                    state.rosterList = list;
                    app.renderAdminToday();
                    app.renderUserRegisterList();
                });

                // 3. Users
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.usersList = list;
                    state.myUserData = list.find(u => u.id === state.currentUser.uid) || null;
                    app.renderAdminToday();
                    app.checkAndRouteUser();
                });

                // 4. Requests
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.pendingRequests = list;
                    state.myPendingRequest = list.find(r => r.id === state.currentUser.uid) || null;
                    app.renderAdminRequests();
                    app.checkAndRouteUser();
                });

                // 5. History
                const historyQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'history'), orderBy('dateStr', 'desc'), limit(30));
                onSnapshot(historyQuery, (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    state.historyList = list;
                    app.renderAdminHistory();
                });
            },

            checkAndRunAutoArchive: async () => {
                const todayStr = app.getTodayStr();
                const systemDate = state.systemDate;
                if (systemDate && systemDate < todayStr) {
                    const statusEl = document.getElementById('auto-archive-status');
                    statusEl.classList.remove('hidden');
                    try {
                        // Archive logic with manual status support
                        const historyRecords = state.rosterList.map(rosterItem => {
                            const user = state.usersList.find(u => u.id === rosterItem.assignedUid);
                            const isCheckedIn = user && user.checkInDate === systemDate;
                            
                            let status = 'absent';
                            let penalty = '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                            let timeStr = '-';

                            if (isCheckedIn) {
                                timeStr = app.formatTime(user.checkInTime);
                                status = user.status || 'unknown';
                                penalty = user.penalty || '-';
                            } else if (rosterItem.manualStatus && rosterItem.manualStatusDate === systemDate) {
                                status = rosterItem.manualStatus;
                                if (status === 'sick_leave') penalty = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢';
                                else if (status === 'personal_leave') penalty = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
                            }

                            return { name: rosterItem.name, time: timeStr, status: status, penalty: penalty };
                        });

                        const historyData = {
                            dateStr: systemDate, timestamp: serverTimestamp(),
                            count: historyRecords.filter(r => r.status !== 'absent' && r.status !== 'sick_leave' && r.status !== 'personal_leave').length,
                            records: historyRecords
                        };
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', `day_${systemDate}`), historyData);
                        
                        // Clear User Checkins
                        state.usersList.forEach(async (u) => {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {
                                checkedIn: false, checkInTime: null, checkInDate: null, status: null, penalty: null, lateMinutes: null
                            });
                        });
                        
                        // Clear Roster Manual Statuses
                        state.rosterList.forEach(async (r) => {
                            if (r.manualStatus) {
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', r.id), {
                                    manualStatus: deleteField(),
                                    manualStatusDate: deleteField()
                                });
                            }
                        });

                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { currentDate: todayStr });
                    } catch (e) { console.error("Auto Archive Error", e); } 
                    finally { setTimeout(() => statusEl.classList.add('hidden'), 3000); }
                }
            },
            
            isUserCheckedInToday: (user) => { return user && user.checkInDate === app.getTodayStr(); },

            checkAndRouteUser: () => {
                const adminVisible = document.getElementById('view-admin_dashboard').style.display !== 'none';
                const adminLoginVisible = document.getElementById('view-admin_login').style.display !== 'none';
                if (!adminVisible && !adminLoginVisible) app.routeUserDashboard();
            },

            calculateLateStatus: (checkInDateObj, lateTimeStr) => {
                const [lateHour, lateMinute] = lateTimeStr.split(':').map(Number);
                const lateThreshold = new Date(checkInDateObj);
                lateThreshold.setHours(lateHour, lateMinute, 0, 0);
                const diffMs = checkInDateObj - lateThreshold;
                const diffMins = Math.ceil(diffMs / 60000);

                if (diffMins <= 0) return { status: 'on_time', penalty: '-', lateMinutes: 0 };
                else if (diffMins <= 10) return { status: 'late_mild', penalty: '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ 20 ‡∏ä‡∏¥‡πâ‡∏ô', lateMinutes: diffMins };
                else if (diffMins <= 40) { const pieces = diffMins * 3; return { status: 'late_heavy', penalty: `‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ ${pieces} ‡∏ä‡∏¥‡πâ‡∏ô`, lateMinutes: diffMins }; }
                else return { status: 'absent', penalty: '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', lateMinutes: diffMins };
            },

            // --- ADMIN: Roster Logic ---
            renderAdminToday: () => {
                const listEl = document.getElementById('today-users-list');
                const now = new Date();
                const todayStr = app.getTodayStr();
                
                const unifiedList = state.rosterList.map(rosterItem => {
                    const user = state.usersList.find(u => u.id === rosterItem.assignedUid);
                    const isCheckedIn = user && app.isUserCheckedInToday(user);
                    
                    let status = 'not_arrived';
                    let penalty = '-';
                    let lateMinutes = 0;
                    let timeStr = '-';
                    let checkInTimeVal = Infinity;

                    if (rosterItem.manualStatus && rosterItem.manualStatusDate === todayStr) {
                        status = rosterItem.manualStatus;
                        if (status === 'sick_leave') penalty = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢';
                        else if (status === 'personal_leave') penalty = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
                    } else if (isCheckedIn) {
                        timeStr = app.formatTime(user.checkInTime).split(' ')[1];
                        status = user.status;
                        penalty = user.penalty;
                        lateMinutes = user.lateMinutes;
                        
                        if (user.checkInTime) {
                            checkInTimeVal = user.checkInTime.toDate ? user.checkInTime.toDate().getTime() : new Date(user.checkInTime).getTime();
                        }
                        
                        if (!status && user.checkInTime) {
                             const cd = user.checkInTime.toDate ? user.checkInTime.toDate() : new Date(user.checkInTime);
                             const res = app.calculateLateStatus(cd, state.lateTime);
                             status = res.status; penalty = res.penalty; lateMinutes = res.lateMinutes;
                        }
                    } else {
                        const res = app.calculateLateStatus(now, state.lateTime);
                        if (res.status === 'absent') {
                            status = 'absent';
                            penalty = '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                            lateMinutes = res.lateMinutes;
                        }
                    }

                    return { ...rosterItem, status, penalty, lateMinutes, timeStr, isCheckedIn, checkInTimeVal };
                });

                // Sorting
                unifiedList.sort((a, b) => {
                    if (a.isCheckedIn && !b.isCheckedIn) return -1;
                    if (!a.isCheckedIn && b.isCheckedIn) return 1;
                    if (a.isCheckedIn && b.isCheckedIn) return a.checkInTimeVal - b.checkInTimeVal;
                    return a.name.localeCompare(b.name, 'th');
                });

                const checkedInCount = unifiedList.filter(u => u.isCheckedIn).length;
                document.getElementById('today-checked-in').textContent = checkedInCount;
                document.getElementById('today-total').textContent = unifiedList.length;

                if (unifiedList.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-slate-400 py-8 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                    return;
                }
                
                listEl.innerHTML = unifiedList.map(u => {
                    let statusBadge = '', bgColor = 'bg-white';
                    
                    if (u.status === 'on_time') { 
                        statusBadge = `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded border border-green-200">‡∏õ‡∏Å‡∏ï‡∏¥</span>`; 
                        bgColor = 'bg-green-50/50';
                    } else if (u.status === 'late_mild') { 
                        statusBadge = `<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200">‡∏™‡∏≤‡∏¢ ${u.lateMinutes}‡∏ô. (${u.penalty})</span>`; 
                        bgColor = 'bg-yellow-50/50';
                    } else if (u.status === 'late_heavy') { 
                        statusBadge = `<span class="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded border border-orange-200">‡∏™‡∏≤‡∏¢ ${u.lateMinutes}‡∏ô. (${u.penalty})</span>`; 
                        bgColor = 'bg-orange-50/50';
                    } else if (u.status === 'absent') { 
                        statusBadge = `<span class="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded border border-red-200">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>`; 
                        bgColor = 'bg-red-50/50';
                    } else if (u.status === 'sick_leave') {
                        statusBadge = `<span class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded border border-blue-200">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</span>`;
                        bgColor = 'bg-blue-50/50';
                    } else if (u.status === 'personal_leave') {
                        statusBadge = `<span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">üíº ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>`;
                        bgColor = 'bg-purple-50/50';
                    } else {
                        statusBadge = `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤</span>`;
                    }

                    const icon = u.assignedUid ? (u.isCheckedIn ? 'check' : 'smartphone') : 'user';
                    const iconColor = u.isCheckedIn ? 'text-green-600' : 'text-slate-400';
                    const iconBg = u.isCheckedIn ? 'bg-green-100' : 'bg-slate-100';

                    let actionBtn = '';
                    if (u.isCheckedIn) {
                        actionBtn = `<button onclick="app.handleUnpairUser('${u.assignedUid}', '${u.name}', '${u.id}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"><i data-lucide="unlink" class="w-4 h-4"></i></button>`;
                    } else {
                        actionBtn = `
                            <button onclick="app.handleOpenStatusModal('${u.id}', '${u.status}', '${u.name}')" class="text-slate-300 hover:text-indigo-500 p-2" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><i data-lucide="flag" class="w-4 h-4"></i></button>
                            ${!u.assignedUid ? `<button onclick="app.handleDeleteRoster('${u.id}', '${u.name}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : `<button onclick="app.handleUnpairUser('${u.assignedUid}', '${u.name}', '${u.id}')" class="text-slate-300 hover:text-red-500 p-2" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà"><i data-lucide="unlink" class="w-4 h-4"></i></button>`}
                        `;
                    }

                    return `
                    <div class="flex justify-between items-center p-3 ${bgColor} hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="${iconBg} p-2 rounded-full ${iconColor}"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${u.name}</div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-xs font-mono text-slate-500">${u.timeStr}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            ${actionBtn}
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            },

            // --- Status Modal Actions ---
            handleOpenStatusModal: (rosterId, currentStatus, name) => {
                state.editingRosterId = rosterId;
                document.getElementById('modal-status-name').textContent = name;
                document.getElementById('modal-status-edit').classList.remove('hidden');
            },

            handleSaveStatus: async (status) => {
                if (!state.editingRosterId) return;
                const todayStr = app.getTodayStr();
                try {
                    if (status) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', state.editingRosterId), {
                            manualStatus: status,
                            manualStatusDate: todayStr
                        });
                    } else {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', state.editingRosterId), {
                            manualStatus: deleteField(),
                            manualStatusDate: deleteField()
                        });
                    }
                    document.getElementById('modal-status-edit').classList.add('hidden');
                } catch(e) { alert('Error: ' + e.message); }
            },

            // --- History Management ---
            handleDeleteHistory: async (id) => {
                if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', id));
                } catch(e) { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },

            handleClearAllHistory: async () => {
                if(!confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) return;
                const password = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:');
                if (password !== ADMIN_PIN) return alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');

                try {
                    const promises = state.historyList.map(h =>
                        deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', h.id))
                    );
                    await Promise.all(promises);
                    alert('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                } catch(e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }
            },

            handleAddRoster: async () => {
                const text = document.getElementById('roster-textarea').value;
                if (!text.trim()) return;
                const names = text.split('\n').map(n => n.trim()).filter(n => n);
                try {
                    const batchPromises = names.map(name => 
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), {
                            name: name, assignedUid: null, createdAt: serverTimestamp()
                        })
                    );
                    await Promise.all(batchPromises);
                    document.getElementById('roster-textarea').value = '';
                    document.getElementById('modal-add-roster').classList.add('hidden');
                    alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${names.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                } catch(e) { alert('Error: ' + e.message); }
            },

            handleDeleteRoster: async (id, name) => {
                if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', id));
                }
            },

            handleUnpairUser: async (uid, name, rosterId) => {
                if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà)`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', rosterId), { assignedUid: null });
                }
            },

            renderUserRegisterList: () => {
                const selectEl = document.getElementById('register-name-select');
                if(!selectEl) return;
                const availableNames = state.rosterList.filter(r => !r.assignedUid);
                selectEl.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>' + 
                    availableNames.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            },

            // --- Actions ---
            routeUserDashboard: () => {
                document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
                document.getElementById('global-admin-btn').style.display = 'flex';
                if (state.myUserData) {
                    document.getElementById('view-user_approved').style.display = 'flex';
                    app.startGPS();
                    app.updateUserDashboardUI();
                } else if (state.myPendingRequest) {
                    document.getElementById('view-user_pending').style.display = 'flex';
                    document.getElementById('pending-name-display').textContent = state.myPendingRequest.name;
                    app.stopGPS();
                } else {
                    document.getElementById('view-user_register').style.display = 'flex';
                    app.stopGPS();
                }
                lucide.createIcons();
            },

            startGPS: () => {
                if (state.gpsWatchId) return;
                if ('geolocation' in navigator && state.targetLocation && state.myUserData) {
                    document.getElementById('user-status-message').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS...';
                    state.gpsWatchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const { latitude, longitude } = pos.coords;
                            const dist = app.calculateDistance(latitude, longitude, state.targetLocation.lat, state.targetLocation.lng);
                            document.getElementById('user-distance-display').textContent = Math.round(dist) + ' ‡∏°.';
                            
                            // SHOW USER COORDINATES
                            document.getElementById('user-current-coords').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

                            const radius = state.checkInRadius;
                            document.getElementById('user-distance-display').className = dist <= radius ? 'font-bold text-green-600' : 'font-bold text-slate-800';
                            if (dist <= radius) {
                                document.getElementById('user-status-message').textContent = '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                                app.handleAutoCheckIn();
                            } else {
                                document.getElementById('user-status-message').textContent = `‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (${Math.round(dist)} ‡∏°.)`;
                            }
                        },
                        (err) => { document.getElementById('user-status-message').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ (‡πÄ‡∏õ‡∏¥‡∏î GPS)'; },
                        { enableHighAccuracy: true, maximumAge: 10000 }
                    );
                }
            },

            stopGPS: () => { if (state.gpsWatchId) { navigator.geolocation.clearWatch(state.gpsWatchId); state.gpsWatchId = null; } },

            handleRequestAccess: async () => {
                const selectEl = document.getElementById('register-name-select');
                const rosterId = selectEl.value;
                if (!rosterId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                const rosterItem = state.rosterList.find(r => r.id === rosterId);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', state.currentUser.uid), { 
                    name: rosterItem.name, uid: state.currentUser.uid, rosterId: rosterId, requestedAt: serverTimestamp() 
                });
                alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            },

            handleAutoCheckIn: async () => {
                const todayStr = app.getTodayStr();
                if (state.myUserData && !state.myUserData.checkedIn) {
                    document.getElementById('user-status-message').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                    const now = new Date();
                    const result = app.calculateLateStatus(now, state.lateTime);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', state.currentUser.uid), {
                        checkedIn: true, checkInTime: serverTimestamp(), checkInDate: todayStr, status: result.status, penalty: result.penalty, lateMinutes: result.lateMinutes
                    });
                }
            },

            handleSetLateTime: async () => {
                const val = document.getElementById('admin-late-time-input').value;
                if(!val) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { lateTime: val });
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            },

            handleSetRadius: async () => {
                const val = parseInt(document.getElementById('admin-radius-input').value);
                if (!val || val <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { radius: val });
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            },

            handleResetIdentity: async () => { if (confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?')) { await signOut(auth); window.location.reload(); } },
            checkAdminLogin: () => { 
                if (document.getElementById('admin-pin-input').value === ADMIN_PIN) {
                    router.navigate('admin_dashboard');
                    document.getElementById('admin-pin-input').value = '';
                    app.checkAndRunAutoArchive();
                } else alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î');
            },
            handleSetTargetLocation: () => {
                if ('geolocation' in navigator) navigator.geolocation.getCurrentPosition(async (pos) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system'), { location: { lat: pos.coords.latitude, lng: pos.coords.longitude } });
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                });
            },
            
            handleApproveUser: async (req) => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', req.uid), { 
                        name: req.name, deviceId: req.uid, rosterId: req.rosterId,
                        checkedIn: false, checkInTime: null, checkInDate: null, status: null, penalty: null, lateMinutes: null, registeredAt: serverTimestamp() 
                    });
                    if (req.rosterId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', req.rosterId), { assignedUid: req.uid });
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.uid));
                } catch (e) { alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message); }
            },
            
            handleRejectUser: async (reqId) => { if(confirm("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId)); },
            
            handleResetDay: async () => { 
                if(confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?")) 
                state.usersList.forEach(async (u) => { 
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { 
                        checkedIn: false, checkInTime: null, checkInDate: null, status: null, penalty: null, lateMinutes: null
                    }); 
                }); 
            },

            updateUserDashboardUI: () => {
                if (!state.myUserData) return;
                const u = state.myUserData;
                const isCheckedInToday = app.isUserCheckedInToday(u);
                document.getElementById('user-name-display').textContent = u.name;
                document.getElementById('user-time-display').textContent = isCheckedInToday ? app.formatTime(u.checkInTime).split(' ')[1] : '-';
                const headerBg = document.getElementById('user-header-bg');
                const statusIcon = document.getElementById('user-status-icon');
                const statusTitle = document.getElementById('user-status-title');
                const penaltyCard = document.getElementById('user-penalty-card');
                const warning = document.getElementById('user-no-target-warning');
                
                if (isCheckedInToday) {
                    let status = u.status;
                    let penalty = u.penalty;
                    let lateMinutes = u.lateMinutes;
                    if (!status && u.checkInTime) {
                         const checkInDate = u.checkInTime.toDate ? u.checkInTime.toDate() : new Date(u.checkInTime);
                         const res = app.calculateLateStatus(checkInDate, state.lateTime);
                         status = res.status; penalty = res.penalty; lateMinutes = res.lateMinutes;
                    }

                    if (status === 'late_mild') {
                        headerBg.className = 'bg-yellow-500 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'alert-circle'); statusTitle.textContent = '‡∏™‡∏≤‡∏¢ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢ ${lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else if (status === 'late_heavy') {
                        headerBg.className = 'bg-orange-500 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'alert-triangle'); statusTitle.textContent = '‡∏™‡∏≤‡∏¢ (‡∏°‡∏≤‡∏Å)';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢ ${lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else if (status === 'absent') {
                        headerBg.className = 'bg-red-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'x-circle'); statusTitle.textContent = '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                        penaltyCard.classList.remove('hidden'); document.getElementById('user-penalty-detail').textContent = penalty; document.getElementById('user-penalty-sub').textContent = `‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    } else {
                        headerBg.className = 'bg-green-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                        statusIcon.setAttribute('data-lucide', 'check-circle'); statusTitle.textContent = '‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                        penaltyCard.classList.add('hidden');
                    }
                } else {
                    headerBg.className = 'bg-indigo-600 p-6 pt-16 rounded-b-3xl shadow-xl text-white text-center relative overflow-hidden transition-colors duration-500';
                    statusIcon.setAttribute('data-lucide', 'wifi'); statusTitle.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠';
                    penaltyCard.classList.add('hidden');
                }
                warning.classList.toggle('hidden', !!state.targetLocation);
                lucide.createIcons();
            },

            renderAdminHistory: () => {
                const container = document.getElementById('history-container');
                if (state.historyList.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 text-sm py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</p>'; return; }
                container.innerHTML = state.historyList.map(h => {
                    const dateParts = h.dateStr.split('-');
                    const dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
                    const usersHtml = h.records && h.records.length > 0 ? h.records.map(r => `
                        <div class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm">
                            <div class="flex flex-col"><span class="text-slate-700 font-medium">${r.name}</span><span class="text-[10px] text-slate-400">${r.penalty !== '-' ? r.penalty : '‡∏õ‡∏Å‡∏ï‡∏¥'}</span></div>
                            <span class="text-slate-500 font-mono text-xs">${r.time ? r.time.split(' ')[1] : '-'}</span>
                        </div>`).join('') : '<div class="text-center text-slate-400 text-xs py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
                    return `
                    <div class="history-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 flex justify-between items-center bg-slate-50">
                            <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="this.parentElement.parentElement.classList.toggle('active')">
                                <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg font-bold text-xs flex flex-col items-center min-w-[3rem]">
                                    <span>${dateObj.getDate()}</span><span class="text-[9px] uppercase">${dateObj.toLocaleDateString('en-US', {month:'short'})}</span>
                                </div>
                                <div class="font-bold text-slate-700">${dateStr}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-full cursor-pointer" onclick="this.parentElement.parentElement.parentElement.classList.toggle('active')">${h.count} ‡∏Ñ‡∏ô</span>
                                <button onclick="app.handleDeleteHistory('${h.id}')" class="text-slate-400 hover:text-red-500 p-1" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-down" class="chevron-icon w-4 h-4 text-slate-400 transition-transform duration-300 cursor-pointer" onclick="this.parentElement.parentElement.parentElement.classList.toggle('active')"></i>
                            </div>
                        </div>
                        <div class="history-content bg-white px-4"><div class="py-3">${usersHtml}</div></div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            },

            renderAdminRequests: () => {
                const container = document.getElementById('admin-pending-wrapper');
                const listEl = document.getElementById('admin-pending-list');
                document.getElementById('pending-count').textContent = state.pendingRequests.length;
                if (state.pendingRequests.length > 0) {
                    container.classList.remove('hidden');
                    listEl.innerHTML = state.pendingRequests.map(req => `
                        <div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
                            <div><div class="font-bold text-slate-800">${req.name}</div><div class="text-[10px] text-slate-400">UID: ${req.uid.substring(0,6)}...</div></div>
                            <div class="flex gap-2"><button onclick="app.handleRejectUser('${req.id}')" class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded hover:bg-red-100 hover:text-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button><button onclick="app.handleApproveUser({uid:'${req.uid}', name:'${req.name}', rosterId:'${req.rosterId || ''}'})" class="px-2 py-1 bg-indigo-600 text-white text-xs rounded shadow hover:bg-indigo-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div>
                        </div>`).join('');
                } else { container.classList.add('hidden'); }
                lucide.createIcons();
            },

            calculateDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            },
            formatTime: (t) => { if (!t) return '-'; try { return (t.toDate ? t.toDate() : new Date(t)).toLocaleString('th-TH'); } catch (e) { return '-'; } }
        };

        window.app = app;
        window.router = router;
        app.init();
        lucide.createIcons();
    </script>
</body>
</html>
